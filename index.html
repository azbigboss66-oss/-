<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>åŸºç‹é˜¿ä¹‹Â·V5ç»ˆæç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        /* --- V5.0 è§†è§‰å¼•æ“ --- */
        :root { --bg: #000000; --card: #111111; --border: #222222; --blue: #0A84FF; --red: #FF453A; --green: #30D158; }
        body { background-color: var(--bg); color: #fff; font-family: -apple-system, "SF Pro Text", sans-serif; overflow: hidden; user-select: none; }
        
        /* éšè—æ»šåŠ¨æ¡ */
        .scroller::-webkit-scrollbar { display: none; }
        .scroller { -ms-overflow-style: none; scrollbar-width: none; }

        /* ä»·æ ¼è·³åŠ¨å¾®æ•ˆ */
        .flash-red { animation: flashR 0.8s; }
        .flash-green { animation: flashG 0.8s; }
        @keyframes flashR { 0% { color: #fff; text-shadow: 0 0 10px var(--red); } 100% { color: var(--red); } }
        @keyframes flashG { 0% { color: #fff; text-shadow: 0 0 10px var(--green); } 100% { color: var(--green); } }

        /* æ ‡ç­¾åˆ‡æ¢ */
        .tab-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-active { background: #333; color: white; font-weight: 600; }
        .tab-inactive { color: #666; }

        /* ç»ç’ƒæ€ç»„ä»¶ */
        .glass-nav { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.05); }
        .glass-header { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
        
        /* çŠ¶æ€å‘¼å¸ç¯ */
        .live-dot { width: 6px; height: 6px; border-radius: 50%; box-shadow: 0 0 8px currentColor; animation: breathe 2s infinite; }
        @keyframes breathe { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
    </style>
</head>
<body class="flex flex-col h-screen w-full text-sm">

    <header class="h-12 flex items-center justify-between px-4 glass-header z-50 fixed top-0 w-full">
        <div class="flex items-center gap-2">
            <div id="statusDot" class="live-dot text-yellow-500"></div>
            <h1 class="font-bold text-base tracking-wide">åŸºç‹<span class="text-blue-500">é˜¿ä¹‹</span> <span class="text-[9px] border border-gray-700 px-1 rounded text-gray-500">V5.0</span></h1>
        </div>
        <div class="font-mono text-gray-500 text-xs" id="clock">00:00:00</div>
    </header>

    <main class="flex-1 overflow-y-auto scroller pb-24 pt-12 bg-black" id="mainView">
        
        <div id="view-market" class="p-3 space-y-3 fade-in">
            
            <div class="bg-[#111] p-4 rounded-xl border border-[#222] relative overflow-hidden shadow-2xl">
                <div class="absolute -right-4 -top-4 text-[#1a1a1a] opacity-50"><i class="fas fa-chart-pie text-9xl"></i></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">ä»Šæ—¥é¢„ä¼°ç›ˆäº (CNY)</div>
                            <div class="flex items-baseline gap-2">
                                <span id="dayPnL" class="text-3xl font-bold font-mono tracking-tighter text-gray-200">0.00</span>
                                <span id="dayPnLRate" class="text-xs font-bold px-1.5 py-0.5 rounded bg-[#222] text-gray-500">0.00%</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">æ€»æŒæœ‰èµ„äº§</div>
                            <div id="totalAsset" class="text-xl font-mono font-bold text-gray-100">0.00</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 border-t border-[#222] pt-3">
                        <div>
                            <div class="text-[10px] text-gray-600">ç´¯è®¡æ€»ç›ˆäº</div>
                            <div id="totalPnL" class="font-mono text-gray-300">0.00</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-600">æ•°æ®æºçŠ¶æ€</div>
                            <div id="dataStatus" class="text-[10px] text-green-500 flex items-center justify-end gap-1">
                                <i class="fas fa-satellite-dish"></i> åŒæ¨¡å¼•æ“æ­£å¸¸
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="indexGrid">
                </div>

            <div class="bg-[#111] rounded-xl border border-[#222] p-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-300 flex items-center gap-1"><i class="fas fa-fire text-red-500"></i> å®æ—¶é£å£</span>
                    <span class="text-[10px] text-gray-600">ä¸»åŠ›èµ„é‡‘æµå‘</span>
                </div>
                <div id="sectorList" class="space-y-2">
                    <div class="text-center text-[10px] text-gray-700 py-2">å…¨å¸‚åœºæ‰«æä¸­...</div>
                </div>
            </div>

            <div class="bg-[#111] rounded-xl border border-[#222] h-64 flex flex-col">
                <div class="flex justify-between items-center p-2 border-b border-[#222] bg-[#161616]">
                    <span id="chartName" class="text-xs font-bold text-gray-300 ml-2">ä¸Šè¯æŒ‡æ•°</span>
                    <div class="flex gap-1 text-[10px]">
                        <button onclick="App.loadKLine('1.000001', 'ä¸Šè¯')" class="px-2 py-1 bg-[#222] text-gray-400 rounded hover:text-white">Aè‚¡</button>
                        <button onclick="App.loadKLine('100.NDX', 'çº³æŒ‡')" class="px-2 py-1 bg-[#222] text-gray-400 rounded hover:text-white">ç¾è‚¡</button>
                        <button onclick="App.loadKLine('1.BK0493', 'åŠå¯¼ä½“')" class="px-2 py-1 bg-[#222] text-gray-400 rounded hover:text-white">åŠå¯¼ä½“</button>
                    </div>
                </div>
                <div id="klineChart" class="flex-1 w-full"></div>
            </div>
        </div>

        <div id="view-portfolio" class="p-3 space-y-3 hidden fade-in">
            <div class="flex gap-2 sticky top-14 z-20">
                <input id="quickAddCode" type="text" placeholder="è¾“å…¥ä»£ç  (å¦‚ 001840, 600519)" class="flex-1 bg-[#111] border border-[#333] rounded-lg px-3 text-sm text-white outline-none focus:border-blue-500 placeholder-gray-700">
                <button onclick="App.openAddModal()" class="bg-blue-600 px-4 rounded-lg text-white font-bold text-xs shadow-lg shadow-blue-900/30 active:scale-95 transition-transform">
                    <i class="fas fa-plus"></i> æ·»åŠ 
                </button>
            </div>

            <div class="flex bg-[#111] p-1 rounded-lg border border-[#222]">
                <button onclick="App.switchList('holding')" id="tab-holding" class="flex-1 py-1.5 text-xs rounded text-center tab-active">å®ç›˜æŒä»“</button>
                <button onclick="App.switchList('watching')" id="tab-watching" class="flex-1 py-1.5 text-xs rounded text-center tab-inactive">æš—ä¸­è§‚å¯Ÿ</button>
            </div>

            <div id="assetList" class="space-y-2 pb-20 min-h-[300px]">
                </div>
        </div>

        <div id="view-ai" class="flex flex-col h-full hidden p-3 pb-0 fade-in">
            <div class="flex-1 bg-[#111] rounded-xl border border-[#222] flex flex-col overflow-hidden relative shadow-inner">
                <div class="h-10 border-b border-[#222] flex justify-between items-center px-3 bg-[#161616]">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-xs font-bold text-gray-300">é˜¿ä¹‹ Agent</span>
                    </div>
                    <button onclick="AI.clear()" class="text-gray-500 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>
                
                <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-3 scroller">
                    <div class="bg-[#222] p-3 rounded-r-xl rounded-bl-xl text-xs text-gray-300 max-w-[85%] border border-[#333]">
                        æˆ‘æ˜¯é˜¿ä¹‹ã€‚ä½ çš„èµ„äº§ç›‘æ§ä¸­æ¢ã€‚<br>æˆ‘å·²ç»åˆ†æ¸…äº†ä½ çš„â€œè‚¡ç¥¨è‚¡æ•°â€å’Œâ€œåŸºé‡‘ä»½é¢â€ï¼Œåˆ«å†æ‹…å¿ƒç®—é”™è´¦äº†ã€‚
                    </div>
                </div>
                
                <div class="p-3 bg-black border-t border-[#222]">
                    <div class="flex gap-2 mb-2">
                        <button onclick="AI.analyze('holding')" class="flex-1 bg-blue-900/10 text-blue-500 py-2 rounded text-xs border border-blue-900/30 hover:bg-blue-900/20">ğŸ“Š è¯Šæ–­æŒä»“</button>
                        <button onclick="AI.analyze('watching')" class="flex-1 bg-purple-900/10 text-purple-500 py-2 rounded text-xs border border-purple-900/30 hover:bg-purple-900/20">ğŸ‘€ æœºä¼šåˆ†æ</button>
                    </div>
                    <div class="relative">
                        <input id="aiInput" class="w-full bg-[#161616] text-xs text-white p-3 pr-8 rounded-lg outline-none border border-[#333] focus:border-blue-500" placeholder="è¾“å…¥ Key æˆ– æé—®...">
                        <button onclick="AI.send()" class="absolute right-2 top-2.5 text-blue-500 p-1"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div class="h-20"></div>
        </div>

        <div id="view-settings" class="p-4 hidden fade-in">
            <div class="bg-[#111] rounded-xl p-4 border border-[#222] space-y-4">
                <h3 class="text-sm font-bold text-gray-300 border-b border-[#222] pb-2">é…ç½®ä¸­å¿ƒ</h3>
                <div>
                    <label class="text-[10px] text-gray-500 uppercase">Google Gemini API Key</label>
                    <input id="settingKey" type="password" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white mt-1 font-mono" placeholder="AIza...">
                </div>
                <button onclick="App.saveSettings()" class="w-full bg-blue-600 py-2.5 rounded text-xs font-bold text-white shadow-lg shadow-blue-900/30">ä¿å­˜ç”Ÿæ•ˆ</button>
                <div class="text-[10px] text-gray-600 text-center pt-2">
                    åŒæ¨¡å¼•æ“: Push2 (Stock) + FundGZ (Fund)
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full h-16 glass-nav z-50 flex justify-around items-center pb-safe">
        <div onclick="App.nav('market')" class="nav-btn active flex flex-col items-center w-1/4 opacity-100 transition-opacity">
            <i class="fas fa-chart-line text-lg mb-1"></i><span class="text-[10px]">è¡Œæƒ…</span>
        </div>
        <div onclick="App.nav('portfolio')" class="nav-btn flex flex-col items-center w-1/4 opacity-50 transition-opacity">
            <i class="fas fa-wallet text-lg mb-1"></i><span class="text-[10px]">èµ„äº§</span>
        </div>
        <div onclick="App.nav('ai')" class="nav-btn flex flex-col items-center w-1/4 opacity-50 transition-opacity">
            <div class="relative">
                <i class="fas fa-robot text-lg mb-1"></i>
            </div>
            <span class="text-[10px]">é˜¿ä¹‹</span>
        </div>
        <div onclick="App.nav('settings')" class="nav-btn flex flex-col items-center w-1/4 opacity-50 transition-opacity">
            <i class="fas fa-sliders-h text-lg mb-1"></i><span class="text-[10px]">è®¾ç½®</span>
        </div>
    </nav>

    <div id="addModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#181818] w-full max-w-xs rounded-xl p-5 border border-[#333] shadow-2xl">
            <h3 class="text-sm font-bold text-white mb-4 flex justify-between">
                <span>æ·»åŠ èµ„äº§</span>
                <span class="text-[10px] text-blue-400 bg-blue-900/20 px-2 py-0.5 rounded" id="modalTypeTag">è‡ªåŠ¨è¯†åˆ«</span>
            </h3>
            
            <div class="space-y-4">
                <div class="flex bg-black p-1 rounded-lg">
                    <button onclick="App.setAddMode('holding')" id="btn-add-hold" class="flex-1 py-1.5 text-xs rounded font-bold bg-[#333] text-white transition-all">å®ç›˜æŒä»“</button>
                    <button onclick="App.setAddMode('watching')" id="btn-add-watch" class="flex-1 py-1.5 text-xs rounded text-gray-500 transition-all">ä»…è§‚æœ›</button>
                </div>
                
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">èµ„äº§ä»£ç </label>
                    <input id="modalCode" disabled class="w-full bg-[#111] border border-[#333] rounded p-2 text-xs text-gray-300 font-mono">
                </div>

                <div id="holdInputs" class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">æŒä»“æˆæœ¬ (å•ä»·)</label>
                        <input id="modalCost" type="number" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white focus:border-blue-500 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1" id="labelVol">æŒæœ‰æ•°é‡ (è‚¡)</label> <input id="modalVol" type="number" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white focus:border-blue-500 outline-none" placeholder="0">
                    </div>
                </div>
                
                <div class="flex gap-3 mt-2">
                    <button onclick="document.getElementById('addModal').classList.add('hidden')" class="flex-1 py-2.5 rounded border border-[#333] text-xs text-gray-400 hover:bg-[#222]">å–æ¶ˆ</button>
                    <button onclick="App.confirmAdd()" class="flex-1 py-2.5 rounded bg-blue-600 text-xs text-white font-bold shadow-lg shadow-blue-600/20">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === ğŸ¥· å¿è€…æ•°æ®å¼•æ“ V5 (åŒæ¨¡æ··åˆ) ===
        const Ninja = {
            // å¼•æ“ A: è‚¡ç¥¨/ETF/å¤§ç›˜ (Eastmoney Push2)
            fetchStock(url) {
                return new Promise((resolve, reject) => {
                    const cb = `cb_stock_${Math.random().toString(36).substr(2, 6)}`;
                    const s = document.createElement('script');
                    s.referrerPolicy = 'no-referrer'; 
                    s.src = `${url}${url.includes('?')?'&':'?'}callback=${cb}`;
                    const t = setTimeout(() => { cleanup(); reject('timeout'); }, 3000);
                    window[cb] = (res) => { cleanup(); resolve(res); };
                    function cleanup() { clearTimeout(t); if(s.parentNode) s.parentNode.removeChild(s); delete window[cb]; }
                    s.onerror = () => { cleanup(); reject('error'); };
                    document.body.appendChild(s);
                });
            },

            // å¼•æ“ B: åœºå¤–åŸºé‡‘ (FundGZ HTTPS)
            // è§£å†³ "åŸºé‡‘æ²¡æœ‰è‚¡æ•°" å’Œ "å‡€å€¼æ›´æ–°æ…¢" çš„é—®é¢˜ï¼Œç›´æ¥æŠ“å–ç›˜ä¸­ä¼°å€¼
            fetchFund(code) {
                return new Promise((resolve) => {
                    const cb = `jsonpgz`; // å›ºå®šå›è°ƒå
                    const s = document.createElement('script');
                    // ä½¿ç”¨ HTTPS æ¥å£é˜²æ­¢è¢« Block
                    s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                    
                    // æ‹¦æˆªå…¨å±€ jsonpgz å›è°ƒ
                    const originalCb = window.jsonpgz;
                    window.jsonpgz = (data) => {
                        resolve(data); // æˆåŠŸæ‹¿åˆ°ä¼°å€¼
                        if(originalCb) window.jsonpgz = originalCb; // æ¢å¤
                        if(s.parentNode) s.parentNode.removeChild(s);
                    };
                    
                    s.onerror = () => { 
                        if(s.parentNode) s.parentNode.removeChild(s); 
                        resolve(null); // å¤±è´¥è¿”å›ç©º
                    };
                    document.body.appendChild(s);
                });
            },

            // æ™ºèƒ½è¯†åˆ«ç±»å‹
            identify(code) {
                code = code.toString();
                // ç®€å•è§„åˆ™ï¼š6ä½æ•°å­—ï¼Œä»¥ 00, 01, 20 ç­‰å¼€å¤´é€šå¸¸æ˜¯åœºå¤–åŸºé‡‘ï¼Œé™¤éæ˜¯ 00xxxx æ·±å¸‚è‚¡ç¥¨
                // æ›´åŠ é²æ£’çš„åˆ¤æ–­ï¼šç”¨æˆ·è¾“å…¥æ—¶é€‰æ‹©ï¼Œæˆ–è€…é»˜è®¤å°è¯•ä¸¤ç§å¼•æ“
                // è¿™é‡Œé‡‡ç”¨ "ä¼˜å…ˆåœºå¤–åŸºé‡‘å¼•æ“" ç­–ç•¥ç»™ 6ä½çº¯æ•°å­—ä¸”ä¸ä»¥ 6/3/9 å¼€å¤´çš„
                if(/^\d{6}$/.test(code)) {
                    if(code.startsWith('00') || code.startsWith('01') || code.startsWith('2') || code.startsWith('16')) {
                        // 16å¼€å¤´æ˜¯LOFï¼Œæ—¢å¯ä»¥åœºå†…ä¹Ÿå¯ä»¥åœºå¤–ã€‚V5ç‰ˆé»˜è®¤èµ°åœºå†…(Stock)å¼•æ“å› ä¸ºå®æ—¶æ€§æ›´å¼ºï¼Œ
                        // ä½†å¦‚æœæ˜¯çº¯ç²¹çš„åœºå¤–åŸºï¼ˆå¦‚001840ï¼‰ï¼Œèµ°Fundå¼•æ“ã€‚
                        // ç­–ç•¥ï¼šæ‰€æœ‰6ä½æ•°å­—å…ˆå°è¯•å½’ä¸€åŒ–ä¸ºStockï¼Œå¦‚æœStockæ²¡æ•°æ®ï¼Œæˆ–æ˜¯ç‰¹å®šå·æ®µï¼Œæ ‡è®°ä¸ºFund
                        if(code.startsWith('00') || code.startsWith('01')) return 'fund';
                    }
                }
                return 'stock';
            },

            // è‚¡ç¥¨ä»£ç æ ‡å‡†åŒ–
            normalizeStock(code) {
                code = code.toUpperCase();
                if(code.includes('.')) return code;
                if(code.startsWith('BK')) return `90.${code}`; 
                if(/^\d{5}$/.test(code)) return `116.${code}`; // æ¸¯è‚¡
                if(/^[A-Z]+$/.test(code)) return `100.${code}`; // ç¾è‚¡
                if(/^(6|9|5|8)/.test(code)) return `1.${code}`; // æ²ªå¸‚
                return `0.${code}`; // æ·±å¸‚
            }
        };

        // === ğŸ“± å…¨å±€æ§åˆ¶å™¨ V5 ===
        const App = {
            assets: JSON.parse(localStorage.getItem('azhi_assets_v5') || '[]'),
            cache: {}, // è‚¡ç¥¨ç¼“å­˜
            fundCache: {}, // åŸºé‡‘ç¼“å­˜
            currentList: 'holding',
            addModeTemp: 'holding',
            addTypeTemp: 'stock', // stock | fund

            init() {
                this.startTime();
                this.initChart();
                this.loop();
                this.renderList();
                // æ¢å¤ Key
                if(localStorage.getItem('azhi_key')) document.getElementById('settingKey').value = localStorage.getItem('azhi_key');
            },

            // --- æ ¸å¿ƒåŒå¾ªç¯ ---
            async loop() {
                const beat = async () => {
                    document.getElementById('statusDot').className = "live-dot text-yellow-500";
                    
                    try {
                        // 1. åˆ†ç¦»èµ„äº§ç±»å‹
                        const stockCodes = ["1.000001", "0.399006", "100.NDX", "1.BK0493"]; // é¢„è®¾æŒ‡æ•°
                        const fundCodes = [];

                        this.assets.forEach(a => {
                            if(a.type === 'fund') fundCodes.push(a.code);
                            else stockCodes.push(Ninja.normalizeStock(a.code));
                        });

                        // 2. å¹¶è¡Œè¯·æ±‚
                        const promises = [];

                        // ä»»åŠ¡A: è‚¡ç¥¨å¼•æ“
                        if(stockCodes.length > 0) {
                            const url = `https://push2.eastmoney.com/api/qt/ulist/get?secids=${[...new Set(stockCodes)].join(',')}&fields=f2,f3,f4,f12,f14,f62`;
                            promises.push(Ninja.fetchStock(url).then(res => {
                                if(res?.data?.diff) res.data.diff.forEach(d => this.cache[d.f12] = d);
                            }));
                        }

                        // ä»»åŠ¡B: åŸºé‡‘å¼•æ“ (æ¯ä¸ªåŸºé‡‘å•ç‹¬å‘è¯·æ±‚ï¼ŒPromise.all)
                        fundCodes.forEach(code => {
                            promises.push(Ninja.fetchFund(code).then(res => {
                                if(res) this.fundCache[code] = res;
                            }));
                        });

                        await Promise.all(promises);

                        // 3. è®¡ç®—ä¸æ¸²æŸ“
                        this.calc();
                        this.renderMarket();
                        this.renderListRow();
                        this.fetchSectors();
                        
                        document.getElementById('statusDot').className = "live-dot text-green-500 shadow-[0_0_8px_#30d158]";
                        document.getElementById('dataStatus').innerHTML = '<i class="fas fa-check-circle"></i> V5åŒæ¨¡å¼•æ“è¿è½¬ä¸­';
                    } catch(e) {
                        console.error(e);
                        document.getElementById('statusDot').className = "live-dot text-red-500";
                    }
                };
                beat();
                setInterval(beat, 2500); // 2.5ç§’åˆ·æ–°
            },

            // --- ç²¾ç¡®è®¡ç®— (åŒºåˆ†è‚¡æ•°/ä»½é¢) ---
            calc() {
                let dayPnL = 0;
                let totalAsset = 0;
                let totalCost = 0;

                this.assets.forEach(a => {
                    if(a.mode !== 'holding') return;

                    let price = 0;
                    let change = 0; // æ¶¨è·Œé¢
                    let changeRate = 0;

                    if(a.type === 'fund') {
                        const d = this.fundCache[a.code];
                        if(d) {
                            price = parseFloat(d.gsz); // å®æ—¶ä¼°å€¼
                            // åŸºé‡‘æ²¡æœ‰ç›´æ¥çš„"æ¶¨è·Œé¢"ï¼Œéœ€è®¡ç®—: æ˜¨æ”¶ * æ¶¨å¹…% (è¿‘ä¼¼)
                            // æˆ–è€…: ä¼°å€¼ - æ˜¨å‡€å€¼
                            const lastNav = parseFloat(d.dwjz); // æ˜¨å‡€å€¼
                            change = price - lastNav;
                        }
                    } else {
                        const d = this.cache[a.code];
                        if(d) {
                            price = d.f2;
                            change = d.f4; // äº¤æ˜“æ‰€ç²¾ç¡®æ¶¨è·Œé¢
                        }
                    }

                    if(price > 0) {
                        dayPnL += change * a.vol;
                        totalAsset += price * a.vol;
                        totalCost += a.cost * a.vol;
                    }
                });

                // UI æ›´æ–°
                const pnlEl = document.getElementById('dayPnL');
                pnlEl.innerText = (dayPnL>0?'+':'') + dayPnL.toFixed(2);
                pnlEl.className = `text-3xl font-bold font-mono tracking-tighter ${dayPnL>=0?'text-red-500':'text-green-500'}`;
                
                const rate = totalCost > 0 ? (dayPnL / totalCost * 100).toFixed(2) : "0.00";
                document.getElementById('dayPnLRate').innerText = (rate>0?'+':'') + rate + '%';
                document.getElementById('dayPnLRate').className = `text-xs font-bold px-1.5 py-0.5 rounded ${dayPnL>=0?'bg-red-900/30 text-red-400':'bg-green-900/30 text-green-400'}`;

                document.getElementById('totalAsset').innerText = Math.round(totalAsset).toLocaleString();
                
                const allPnL = totalAsset - totalCost;
                document.getElementById('totalPnL').innerText = (allPnL>0?'+':'') + allPnL.toFixed(2);
                document.getElementById('totalPnL').className = `font-mono ${allPnL>=0?'text-red-500':'text-green-500'}`;
            },

            // --- åˆ—è¡¨æ¸²æŸ“ (æ™ºèƒ½è¯æœ¯ï¼šè‚¡ vs ä»½é¢) ---
            renderList() {
                const list = document.getElementById('assetList');
                list.innerHTML = '';
                const items = this.assets.filter(a => a.mode === this.currentList);
                
                if(items.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-700 text-xs py-10">æš‚æ— èµ„äº§</div>`;
                    return;
                }

                items.forEach((a, idx) => {
                    const realIdx = this.assets.indexOf(a);
                    const isFund = a.type === 'fund';
                    const unitLabel = isFund ? 'ä»½é¢' : 'è‚¡';
                    
                    list.innerHTML += `
                        <div class="bg-[#111] p-3 rounded-lg border border-[#222] flex justify-between items-center group relative overflow-hidden">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] px-1 rounded ${isFund?'bg-orange-900/30 text-orange-400':'bg-blue-900/30 text-blue-400'}">${isFund?'åŸºé‡‘':'è‚¡ç¥¨'}</span>
                                    <span class="font-bold text-sm text-gray-200" id="name_${a.code}">${a.code}</span>
                                </div>
                                <div class="text-[10px] text-gray-500 mt-1">
                                    ${this.currentList==='holding' ? `æŒ ${a.vol}${unitLabel} @ ${a.cost}` : 'æš—ä¸­è§‚å¯Ÿ'}
                                </div>
                            </div>
                            <div class="text-right z-10" id="val_${a.code}">
                                <div class="text-xs text-gray-500">Loading...</div>
                            </div>
                            <button onclick="App.delAsset(${realIdx})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-900/80 text-white flex items-center justify-center translate-x-full group-hover:translate-x-0 transition-transform">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
            },

            renderListRow() {
                this.assets.forEach(a => {
                    if(a.mode !== this.currentList) return;
                    
                    let name = '--';
                    let price = 0;
                    let rate = 0;
                    let estTime = '';

                    if(a.type === 'fund') {
                        const d = this.fundCache[a.code];
                        if(d) {
                            name = d.name;
                            price = d.gsz; // ä¼°å€¼
                            rate = d.gszzl; // ä¼°å€¼æ¶¨è·Œ
                            estTime = d.gztime.split(' ')[1]; // ä¼°å€¼æ—¶é—´
                        }
                    } else {
                        const d = this.cache[a.code];
                        if(d) {
                            name = d.f14;
                            price = d.f2;
                            rate = d.f3;
                        }
                    }

                    if(price !== 0) {
                        const nameEl = document.getElementById(`name_${a.code}`);
                        if(nameEl) nameEl.innerText = name;
                        
                        const valEl = document.getElementById(`val_${a.code}`);
                        if(valEl) {
                            const color = rate >= 0 ? 'text-red-500' : 'text-green-500';
                            valEl.innerHTML = `
                                <div class="font-bold font-mono ${color}">${price}</div>
                                <div class="text-[10px] ${color}">${rate>0?'+':''}${rate}% ${estTime ? `<span class="text-gray-600 ml-1 scale-75 origin-right inline-block">${estTime}</span>` : ''}</div>
                            `;
                        }
                    }
                });
            },

            // --- æ·»åŠ èµ„äº§é€»è¾‘ (å…³é”®ä¿®å¤ï¼šè‚¡æ•° vs ä»½é¢) ---
            openAddModal() {
                const input = document.getElementById('quickAddCode');
                const code = input.value.trim();
                if(!code) return alert("è¯·è¾“å…¥ä»£ç ");
                
                // è‡ªåŠ¨è¯†åˆ«ç±»å‹
                const type = Ninja.identify(code);
                this.addTypeTemp = type;
                
                document.getElementById('modalCode').value = code;
                document.getElementById('modalTypeTag').innerText = type === 'fund' ? 'åœºå¤–åŸºé‡‘' : 'è‚¡ç¥¨/ETF';
                document.getElementById('modalTypeTag').className = type === 'fund' ? 'text-[10px] text-orange-400 bg-orange-900/20 px-2 py-0.5 rounded' : 'text-[10px] text-blue-400 bg-blue-900/20 px-2 py-0.5 rounded';
                
                // åŠ¨æ€ä¿®æ”¹ Label
                document.getElementById('labelVol').innerText = type === 'fund' ? 'æŒæœ‰ä»½é¢ (ä»½)' : 'æŒæœ‰æ•°é‡ (è‚¡)';
                
                document.getElementById('addModal').classList.remove('hidden');
                input.value = '';
                this.setAddMode('holding');
            },

            setAddMode(mode) {
                this.addModeTemp = mode;
                const btnHold = document.getElementById('btn-add-hold');
                const btnWatch = document.getElementById('btn-add-watch');
                const inputs = document.getElementById('holdInputs');
                
                if(mode === 'holding') {
                    btnHold.className = "flex-1 py-1.5 text-xs rounded font-bold bg-[#333] text-white transition-all";
                    btnWatch.className = "flex-1 py-1.5 text-xs rounded text-gray-500 transition-all";
                    inputs.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    btnHold.className = "flex-1 py-1.5 text-xs rounded text-gray-500 transition-all";
                    btnWatch.className = "flex-1 py-1.5 text-xs rounded font-bold bg-[#333] text-white transition-all";
                    inputs.classList.add('opacity-50', 'pointer-events-none');
                }
            },

            confirmAdd() {
                const code = document.getElementById('modalCode').value;
                const cost = parseFloat(document.getElementById('modalCost').value) || 0;
                const vol = parseFloat(document.getElementById('modalVol').value) || 0;
                
                this.assets.push({
                    code, 
                    cost, 
                    vol, 
                    mode: this.addModeTemp,
                    type: this.addTypeTemp
                });
                
                localStorage.setItem('azhi_assets_v5', JSON.stringify(this.assets));
                document.getElementById('addModal').classList.add('hidden');
                
                if(this.currentList !== this.addModeTemp) this.switchList(this.addModeTemp);
                else this.renderList();
                this.loop();
            },

            // --- è¾…åŠ©åŠŸèƒ½ ---
            fetchSectors() {
                Ninja.fetchStock(`https://push2.eastmoney.com/api/qt/clist/get?pn=1&pz=6&po=1&np=1&ut=bd1d9ddb04089700cf9c27f6f7426281&fltt=2&invt=2&fid=f3&fs=m:90+t:2+f:!50&fields=f12,f14,f3,f62`).then(res => {
                    if(res?.data?.diff) {
                        const list = document.getElementById('sectorList');
                        list.innerHTML = '';
                        res.data.diff.forEach(s => {
                            const flow = (s.f62/1e8).toFixed(1);
                            list.innerHTML += `<div class="flex justify-between text-[10px] border-b border-[#222] pb-1 last:border-0"><span class="text-gray-400">${s.f14}</span><span class="text-red-500">+${s.f3}%</span><span class="${flow>0?'text-red-500':'text-green-500'}">${flow}äº¿</span></div>`;
                        });
                    }
                });
            },
            
            renderMarket() {
                const idxs = ['1.000001','0.399006','100.NDX','1.BK0493'];
                const grid = document.getElementById('indexGrid');
                grid.innerHTML = '';
                idxs.forEach(c => {
                    const d = this.cache[Ninja.normalizeStock(c)] || this.cache[c.split('.')[1]];
                    if(d) {
                        grid.innerHTML += `<div class="bg-[#111] p-2 rounded border border-[#222] text-center"><div class="text-[10px] text-gray-500">${d.f14}</div><div class="font-bold text-gray-200 text-xs">${d.f2}</div><div class="text-[9px] ${d.f3>=0?'text-red-500':'text-green-500'}">${d.f3}%</div></div>`;
                    }
                });
            },

            switchList(mode) {
                this.currentList = mode;
                document.getElementById('tab-holding').className = mode === 'holding' ? 'flex-1 py-1.5 text-xs rounded text-center tab-active' : 'flex-1 py-1.5 text-xs rounded text-center tab-inactive';
                document.getElementById('tab-watching').className = mode === 'watching' ? 'flex-1 py-1.5 text-xs rounded text-center tab-active' : 'flex-1 py-1.5 text-xs rounded text-center tab-inactive';
                this.renderList();
                this.renderListRow();
            },

            delAsset(idx) {
                if(confirm("ç¡®å®šåˆ é™¤?")) {
                    this.assets.splice(idx, 1);
                    localStorage.setItem('azhi_assets_v5', JSON.stringify(this.assets));
                    this.renderList();
                }
            },

            nav(page) {
                document.querySelectorAll('main > div').forEach(e => e.classList.add('hidden', 'fade-in'));
                document.getElementById(`view-${page}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(e => { e.classList.remove('active'); e.classList.add('opacity-50'); });
                event.currentTarget.classList.add('active');
                event.currentTarget.classList.remove('opacity-50');
            },

            saveSettings() {
                const k = document.getElementById('settingKey').value.trim();
                localStorage.setItem('azhi_key', k);
                alert("ä¿å­˜æˆåŠŸ");
                location.reload();
            },

            startTime() { setInterval(() => document.getElementById('clock').innerText = dayjs().format('HH:mm:ss'), 1000); },
            
            initChart() {
                this.chart = echarts.init(document.getElementById('klineChart'));
                this.loadKLine('1.000001', 'ä¸Šè¯æŒ‡æ•°');
                window.onresize = () => this.chart.resize();
            },
            
            async loadKLine(secid, name) {
                document.getElementById('chartName').innerText = name;
                const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secid}&fields1=f1&fields2=f51,f52,f53,f54,f55&klt=101&fqt=1&end=20500101&lmt=60`;
                const res = await Ninja.fetchStock(url);
                if(res?.data?.klines) {
                    const d = res.data.klines.map(i => i.split(','));
                    this.chart.setOption({
                        backgroundColor: 'transparent',
                        grid: { left: 0, right: 0, top: 5, bottom: 0 },
                        xAxis: { show: false, data: d.map(i=>i[0]) },
                        yAxis: { show: false, scale: true },
                        series: [{
                            type: 'candlestick',
                            data: d.map(i=>[+i[1], +i[2], +i[3], +i[4]]),
                            itemStyle: { color: '#FF453A', color0: '#30D158', borderColor: '#FF453A', borderColor0: '#30D158' }
                        }]
                    });
                }
            }
        };

        const AI = {
            async analyze(mode) {
                const key = localStorage.getItem('azhi_key');
                if(!key) return App.nav('settings');
                
                const assets = App.assets.filter(a => a.mode === mode);
                const data = assets.map(a => {
                    const isFund = a.type === 'fund';
                    const d = isFund ? App.fundCache[a.code] : App.cache[a.code];
                    const price = isFund ? (d?.gsz||0) : (d?.f2||0);
                    const name = isFund ? (d?.name||a.code) : (d?.f14||a.code);
                    return `${name}(${isFund?'åŸºé‡‘':'è‚¡ç¥¨'}):ç°ä»·${price}`;
                }).join(';');

                this.reply("æ­£åœ¨è¿ç®—...", true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `ä½ å«é˜¿ä¹‹ã€‚è¯·ç®€çŸ­ç‚¹è¯„ç”¨æˆ·èµ„äº§: ${data}` }] }] })
                    });
                    const json = await res.json();
                    this.removeLoading();
                    this.reply(json.candidates[0].content.parts[0].text);
                } catch(e) { this.removeLoading(); this.reply("AI æ‰çº¿äº†"); }
            },
            reply(t, l=false) {
                const b = document.getElementById('chatBox');
                b.innerHTML += `<div class="bg-[#222] p-3 rounded-r-xl rounded-bl-xl text-xs text-gray-300 max-w-[90%] mb-2 border border-[#333]">${l?'...':marked.parse(t)}</div>`;
                b.scrollTop = b.scrollHeight;
            },
            removeLoading() { const l=document.getElementById('chatBox').lastElementChild; if(l&&l.innerHTML.includes('...')) l.remove(); },
            clear() { document.getElementById('chatBox').innerHTML = ''; },
            send() { this.analyze('holding'); }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
