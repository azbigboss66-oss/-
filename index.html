<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>åŸºç‹é˜¿ä¹‹ V9Â·æ— é™ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        /* V9 é‡‘èæš—é»‘é£æ ¼ */
        :root { --bg: #050505; --card: #141414; --border: #262626; --accent: #3b82f6; --red: #ff3b30; --green: #30d158; }
        body { background: var(--bg); color: #e5e5e5; font-family: -apple-system, sans-serif; overflow: hidden; }
        .no-scroll::-webkit-scrollbar { display: none; }
        
        .flash-up { animation: bgRed 0.6s; }
        .flash-down { animation: bgGreen 0.6s; }
        @keyframes bgRed { 0% { background: rgba(255, 59, 48, 0.3); } 100% { background: transparent; } }
        @keyframes bgGreen { 0% { background: rgba(48, 209, 88, 0.3); } 100% { background: transparent; } }

        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: #fff; border-bottom-color: var(--accent); }
        .tab-btn.inactive { color: #666; }

        /* ç»ç’ƒåº•æ  */
        .glass-nav { background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="flex flex-col h-screen w-full">

    <header class="h-12 flex items-center justify-between px-4 border-b border-[#222] bg-[#111] z-50">
        <div class="flex items-center gap-2">
            <div id="pulse" class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
            <h1 class="font-bold text-base tracking-tight">åŸºç‹é˜¿ä¹‹ <span class="text-[9px] bg-indigo-900 text-indigo-300 px-1 rounded">V9</span></h1>
        </div>
        <div class="text-[10px] text-gray-500 font-mono" id="aiProviderDisplay">AI: Off</div>
    </header>

    <main class="flex-1 overflow-y-auto no-scroll pb-32 bg-black relative" id="main">
        
        <div id="view-market" class="p-3 space-y-4 fade-in">
            
            <div class="bg-gradient-to-br from-[#1a1a1a] to-[#0f0f0f] p-4 rounded-xl border border-[#222] shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase">ä»Šæ—¥é¢„ä¼°ç›ˆäº (å®ç›˜)</div>
                        <div class="flex items-baseline gap-2 mt-1">
                            <span id="dayPnL" class="text-3xl font-bold font-mono text-white tracking-tighter">0.00</span>
                            <span id="dayPnLRate" class="text-xs px-1.5 py-0.5 rounded bg-[#222] text-gray-500 font-bold">0.00%</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-500 uppercase">æ€»æŒæœ‰èµ„äº§</div>
                        <div id="totalAsset" class="text-lg font-mono font-bold text-gray-200">0</div>
                    </div>
                </div>
                <div class="mt-3 border-t border-[#222] pt-2 flex justify-between text-[10px] text-gray-600">
                    <span id="marketStatus">æ•°æ®åŒæ­¥ä¸­...</span>
                    <span>Tencent Live</span>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="indices"></div>

            <div class="bg-[#111] rounded-xl border border-[#222] min-h-[400px] flex flex-col">
                <div class="flex border-b border-[#222]">
                    <button onclick="App.switchList('holding')" id="tab-holding" class="flex-1 py-3 text-xs font-bold text-center tab-btn active">å®ç›˜æŒä»“</button>
                    <button onclick="App.switchList('watching')" id="tab-watching" class="flex-1 py-3 text-xs font-bold text-center tab-btn inactive">æš—ä¸­è§‚å¯Ÿ</button>
                </div>
                
                <div id="assetList" class="flex-1 divide-y divide-[#222]">
                    <div class="p-10 text-center text-gray-600 text-xs">åŠ è½½ä¸­...</div>
                </div>
                
                <div class="p-3 border-t border-[#222]">
                    <button onclick="App.openAdd()" class="w-full bg-blue-600/90 hover:bg-blue-600 text-white py-2 rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-900/20">
                        + æ·»åŠ èµ„äº§ (æ”¯æŒAè‚¡/æ¸¯ç¾/åŸºé‡‘)
                    </button>
                </div>
            </div>
        </div>

        <div id="view-ai" class="hidden flex flex-col h-full p-3 pb-0 fade-in">
            <div class="flex-1 bg-[#111] rounded-xl border border-[#222] flex flex-col overflow-hidden relative">
                <div class="h-8 bg-[#1a1a1a] border-b border-[#222] flex justify-between items-center px-3">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-microchip text-xs text-purple-500"></i>
                        <span class="text-[10px] text-gray-400" id="aiModelName">æœªé…ç½®</span>
                    </div>
                    <button onclick="AI.clear()" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>

                <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-3 no-scroll">
                    <div class="bg-[#222] p-3 rounded-r-xl rounded-bl-xl text-xs text-gray-300 w-fit border border-[#333]">
                        æˆ‘æ˜¯é˜¿ä¹‹ã€‚ä¸ç®¡ä½ ç”¨ Geminiã€DeepSeek è¿˜æ˜¯ Ollamaï¼Œæˆ‘éƒ½èƒ½è¿ä¸Šã€‚
                        <br>è¯·åœ¨ã€Œè®¾ç½®ã€é‡Œé…ç½®ä½ çš„ AI å¼•æ“ã€‚
                    </div>
                </div>

                <div class="p-3 bg-black border-t border-[#222]">
                    <div class="flex gap-2 mb-2">
                        <button onclick="AI.analyze('holding')" class="flex-1 bg-blue-900/20 text-blue-400 py-2 rounded text-xs border border-blue-900/30">è¯Šæ–­æŒä»“</button>
                        <button onclick="AI.analyze('watching')" class="flex-1 bg-purple-900/20 text-purple-400 py-2 rounded text-xs border border-purple-900/30">åˆ†ææœºä¼š</button>
                    </div>
                    <div class="relative">
                        <input id="aiInput" class="w-full bg-[#161616] border border-[#333] rounded-lg p-2.5 text-xs text-white focus:border-blue-500 outline-none" placeholder="é—®ç‚¹ä»€ä¹ˆ...">
                        <button onclick="AI.send()" class="absolute right-2 top-2 text-blue-500 p-1"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <div id="view-settings" class="hidden p-4 space-y-4 fade-in">
            <div class="bg-[#111] rounded-xl p-4 border border-[#222] space-y-4">
                <h3 class="font-bold text-gray-300 border-b border-[#222] pb-2 text-sm">AI å¼•æ“é…ç½®</h3>
                
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">é€‰æ‹© AI æä¾›å•†</label>
                    <select id="aiProvider" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white" onchange="App.toggleAiInputs()">
                        <option value="gemini">Google Gemini (å…è´¹/éœ€æ¢¯å­)</option>
                        <option value="deepseek">DeepSeek (å›½å†…æœ€å¼º/æ¨è)</option>
                        <option value="custom">è‡ªå®šä¹‰ (OpenAI/Ollama)</option>
                    </select>
                </div>

                <div id="input-endpoint-group" class="hidden">
                    <label class="text-[10px] text-gray-500 block mb-1">API Endpoint (Base URL)</label>
                    <input id="aiEndpoint" type="text" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-gray-400 font-mono" placeholder="https://api.deepseek.com/v1">
                    <p class="text-[9px] text-gray-600 mt-1">Ollama å¡«: http://localhost:11434/v1 (éœ€é…åˆç”µè„‘ç«¯ç©¿é€)</p>
                </div>

                <div id="input-model-group" class="hidden">
                    <label class="text-[10px] text-gray-500 block mb-1">æ¨¡å‹åç§°</label>
                    <input id="aiModel" type="text" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white font-mono" placeholder="deepseek-chat">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">API Key</label>
                    <input id="aiKey" type="password" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white font-mono" placeholder="sk-...">
                </div>

                <button onclick="App.saveSettings()" class="w-full bg-green-600 py-2.5 rounded text-xs font-bold text-white shadow-lg shadow-green-900/20">ä¿å­˜å¹¶è¿æ¥</button>
            </div>

            <div class="bg-[#111] rounded-xl p-4 border border-[#222]">
                <h3 class="font-bold text-gray-300 border-b border-[#222] pb-2 text-sm">æ•°æ®ç®¡ç†</h3>
                <div class="mt-3 flex gap-2">
                    <button onclick="App.exportData()" class="flex-1 bg-[#222] text-gray-300 py-2 rounded text-xs">å¯¼å‡ºæ•°æ®</button>
                    <button onclick="App.clearData()" class="flex-1 bg-red-900/20 text-red-500 border border-red-900/30 py-2 rounded text-xs">é‡ç½®æ‰€æœ‰</button>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full h-16 glass-nav z-50 flex justify-around items-center pb-safe">
        <button onclick="App.nav('market')" class="nav-icon active w-1/3 flex flex-col items-center text-blue-500 transition-colors">
            <i class="fas fa-chart-line text-lg mb-1"></i><span class="text-[10px]">è¡Œæƒ…</span>
        </button>
        <button onclick="App.nav('ai')" class="nav-icon w-1/3 flex flex-col items-center text-gray-600 transition-colors">
            <i class="fas fa-robot text-lg mb-1"></i><span class="text-[10px]">é˜¿ä¹‹</span>
        </button>
        <button onclick="App.nav('settings')" class="nav-icon w-1/3 flex flex-col items-center text-gray-600 transition-colors">
            <i class="fas fa-cog text-lg mb-1"></i><span class="text-[10px]">è®¾ç½®</span>
        </button>
    </nav>

    <script>
        // === ğŸš€ è…¾è®¯æ•°æ®å¼•æ“ (Tencent Engine) ===
        const Engine = {
            cache: {},
            fetch(codes, cb) {
                const s = document.createElement('script');
                s.src = `https://qt.gtimg.cn/q=${codes}`;
                s.charset = 'gbk';
                s.onload = () => { this.parse(codes.split(',')); cb(true); s.remove(); };
                s.onerror = () => { cb(false); s.remove(); };
                document.head.appendChild(s);
            },
            // åŸºé‡‘ä¸“ç”¨ï¼šFundGZ (å¸¦ä¼°å€¼)
            fetchFund(code, cb) {
                const s = document.createElement('script');
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                const old = window.jsonpgz;
                window.jsonpgz = (data) => {
                    this.cache['f_'+code] = { name: data.name, price: +data.gsz, rate: +data.gszzl }; // ä¼°å€¼
                    if(old) window.jsonpgz = old;
                    s.remove();
                    cb();
                };
                s.onerror = () => s.remove();
                document.head.appendChild(s);
            },
            parse(codes) {
                codes.forEach(c => {
                    const val = window['v_' + c];
                    if(!val) return;
                    const d = val.split('~');
                    // è…¾è®¯æ ¼å¼: [1]åå­— [3]å½“å‰ä»· [32]æ¶¨è·Œå¹…%
                    this.cache[c] = { name: d[1], price: parseFloat(d[3]), rate: parseFloat(d[32]) };
                });
            }
        };

        // === ğŸ§  é€šç”¨ AI é€‚é…å™¨ (Universal AI Adapter) ===
        const AI = {
            config: JSON.parse(localStorage.getItem('azhi_ai_config') || '{"provider":"gemini","key":"","endpoint":"","model":"gemini-1.5-flash"}'),
            
            async analyze(listType) {
                const targetAssets = App.assets.filter(a => a.list === listType);
                if(targetAssets.length === 0) return this.reply("ç³»ç»Ÿ", "åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå…ˆåŠ ç‚¹èµ„äº§å§ã€‚");

                const context = targetAssets.map(a => {
                    const k = a.type==='fund' ? 'f_'+a.code : App.fmtCode(a.code);
                    const d = Engine.cache[k];
                    const pnl = a.cost > 0 && d ? ((d.price - a.cost)/a.cost*100).toFixed(2) + '%' : 'æœªçŸ¥';
                    return d ? `${d.name}:ç°ä»·${d.price},ä»Šæ—¥${d.rate}%,æ€»ç›ˆäº${pnl}` : a.code;
                }).join('; ');

                const prompt = listType === 'holding' 
                    ? `æˆ‘æ˜¯æ¿€è¿›æŠ•èµ„è€…ã€‚è¿™æ˜¯æˆ‘çš„æŒä»“ï¼š[${context}]ã€‚è¯·æ¯’èˆŒç‚¹è¯„æˆ‘çš„æ“ä½œï¼Œå¹¶è®¡ç®—é£é™©ã€‚`
                    : `è¿™æ˜¯æˆ‘çš„è§‚æœ›åˆ—è¡¨ï¼š[${context}]ã€‚å‘Šè¯‰æˆ‘å“ªä¸ªç°åœ¨æ˜¯ä¹°å…¥è‰¯æœºï¼Œå“ªä¸ªæ˜¯é™·é˜±ï¼Ÿ`;

                this.ask(prompt);
            },

            async ask(prompt) {
                if(!this.config.key) return alert("è¯·å…ˆåœ¨è®¾ç½®é¡µé…ç½® AI Keyï¼");
                this.reply("User", prompt);
                this.reply("System", "æ­£åœ¨è¿æ¥å¤§è„‘..."); // Loading msg

                try {
                    let url, body, headers = {'Content-Type': 'application/json'};
                    
                    // 1. Google Gemini (å®˜æ–¹)
                    if (this.config.provider === 'gemini') {
                        // å¼ºåˆ¶ä¿®æ­£ä¸ºå¯ç”¨æ¨¡å‹
                        const model = this.config.model.includes('1.5') ? this.config.model : 'gemini-1.5-flash'; 
                        url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.config.key}`;
                        body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });
                    } 
                    // 2. OpenAI å…¼å®¹ (DeepSeek / Ollama / GPT)
                    else {
                        url = this.config.endpoint || 'https://api.deepseek.com/v1/chat/completions'; // é»˜è®¤ DeepSeek
                        if(!url.endsWith('/chat/completions') && !url.includes('generateContent')) {
                             // ç®€å•æ™ºèƒ½è¡¥å…¨
                             url = url.replace(/\/$/, '') + '/chat/completions';
                        }
                        headers['Authorization'] = `Bearer ${this.config.key}`;
                        body = JSON.stringify({
                            model: this.config.model || 'deepseek-chat',
                            messages: [{role: "system", content: "ä½ å«é˜¿ä¹‹ï¼Œä¸€ä¸ªè¯´è¯åˆ»è–„ä½†ä¸“ä¸šçš„åå°”è¡—äº¤æ˜“å‘˜ã€‚"}, {role: "user", content: prompt}],
                            stream: false
                        });
                    }

                    const res = await fetch(url, { method: 'POST', headers, body });
                    if(!res.ok) {
                        const errText = await res.text();
                        throw new Error(`HTTP ${res.status}: ${errText.slice(0, 100)}...`);
                    }
                    const json = await res.json();
                    
                    // è§£æå“åº” (å…¼å®¹ Gemini å’Œ OpenAI æ ¼å¼)
                    let text = "";
                    if(json.candidates) text = json.candidates[0].content.parts[0].text; // Gemini
                    else if(json.choices) text = json.choices[0].message.content; // OpenAI/DeepSeek
                    else text = JSON.stringify(json);

                    this.removeLoading();
                    this.reply("é˜¿ä¹‹", text);

                } catch(e) {
                    this.removeLoading();
                    this.reply("Error", `è¿æ¥å¤±è´¥: ${e.message}ã€‚è¯·æ£€æŸ¥è®¾ç½®ã€‚`);
                }
            },

            reply(role, text) {
                const box = document.getElementById('chatBox');
                if(role === 'System' && text.includes('è¿æ¥')) {
                    box.innerHTML += `<div id="loadingMsg" class="text-xs text-gray-500 animate-pulse">é˜¿ä¹‹æ€è€ƒä¸­...</div>`;
                    return;
                }
                const color = role === 'User' ? 'bg-blue-900/20 text-blue-300 border-blue-900/50' : (role === 'Error' ? 'bg-red-900/20 text-red-400' : 'bg-[#222] text-gray-300 border-[#333]');
                box.innerHTML += `<div class="p-3 rounded-xl mb-2 text-xs border ${color} fade-in"><b>${role}:</b> ${marked.parse(text)}</div>`;
                box.scrollTop = box.scrollHeight;
            },
            removeLoading() { document.getElementById('loadingMsg')?.remove(); },
            clear() { document.getElementById('chatBox').innerHTML = ''; },
            send() { 
                const v = document.getElementById('aiInput').value; 
                if(v) { this.ask(v); document.getElementById('aiInput').value = ''; } 
            }
        };

        // === ğŸ“± App æ§åˆ¶å™¨ (V9 Logic) ===
        const App = {
            assets: JSON.parse(localStorage.getItem('azhi_assets_v9') || '[]'),
            viewList: 'holding', // 'holding' or 'watching'

            init() {
                this.loop();
                setInterval(() => this.loop(), 2000);
                
                // åˆå§‹åŒ–è®¾ç½®å›æ˜¾
                const conf = AI.config;
                document.getElementById('aiProvider').value = conf.provider;
                document.getElementById('aiKey').value = conf.key;
                document.getElementById('aiEndpoint').value = conf.endpoint;
                document.getElementById('aiModel').value = conf.model;
                this.toggleAiInputs();
                this.renderAiStatus();
            },

            async loop() {
                // 1. æ•´ç†ä»£ç 
                const indices = ['sh000001', 'sz399006', 'usNDAQ', 'hkHSI'];
                const stocks = [], funds = [];
                
                this.assets.forEach(a => {
                    if(a.type === 'fund') funds.push(a.code);
                    else stocks.push(this.fmtCode(a.code));
                });

                // 2. è¯·æ±‚æ•°æ®
                const q = [...indices, ...stocks].join(',');
                if(q) Engine.fetch(q, (ok) => {
                    document.getElementById('pulse').className = ok ? "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#0f0]" : "w-2 h-2 rounded-full bg-red-500";
                    this.renderMarket();
                    this.renderAssets();
                });
                
                funds.forEach(c => Engine.fetchFund(c, () => this.renderAssets()));
            },

            fmtCode(c) {
                if(/^[a-z]{2}/.test(c)) return c; 
                if(/^\d{6}$/.test(c)) return (c.startsWith('6')?'sh':'sz') + c;
                if(/^\d{5}$/.test(c)) return 'hk' + c;
                if(/^[A-Z]+$/.test(c)) return 'us' + c;
                return c;
            },

            renderMarket() {
                // æŒ‡æ•°
                const map = {'sh000001':'ä¸Šè¯','sz399006':'åˆ›ä¸š','usNDAQ':'çº³æŒ‡','hkHSI':'æ’ç”Ÿ'};
                const div = document.getElementById('indices');
                div.innerHTML = '';
                Object.keys(map).forEach(k => {
                    const d = Engine.cache[k];
                    if(d) {
                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        div.innerHTML += `<div class="bg-[#111] p-2 rounded text-center border border-[#222]"><div class="text-[9px] text-gray-500">${map[k]}</div><div class="font-bold text-xs mt-1 text-gray-200">${d.price}</div><div class="text-[9px] ${color}">${d.rate}%</div></div>`;
                    }
                });

                // æ€»èµ„äº§è®¡ç®— (åªç®— holding)
                let total = 0, pnl = 0;
                this.assets.forEach(a => {
                    if(a.list !== 'holding') return;
                    const k = a.type==='fund' ? 'f_'+a.code : this.fmtCode(a.code);
                    const d = Engine.cache[k];
                    if(d) {
                        const val = d.price * a.vol;
                        total += val;
                        // ä¼°ç®—å½“æ—¥ç›ˆäº
                        pnl += val * (d.rate/100) / (1 + d.rate/100);
                    }
                });
                document.getElementById('totalAsset').innerText = Math.round(total).toLocaleString();
                const pEl = document.getElementById('dayPnL');
                pEl.innerText = (pnl>0?'+':'') + pnl.toFixed(2);
                pEl.className = `text-3xl font-bold font-mono tracking-tighter ${pnl>=0?'text-red-500':'text-green-500'}`;
            },

            renderAssets() {
                const list = document.getElementById('assetList');
                list.innerHTML = '';
                const items = this.assets.filter(a => a.list === this.viewList);

                if(items.length === 0) {
                    list.innerHTML = `<div class="p-10 text-center text-gray-700 text-xs">ç©ºç©ºå¦‚ä¹Ÿ</div>`;
                    return;
                }

                items.forEach((a, i) => {
                    const realIdx = this.assets.indexOf(a);
                    const k = a.type==='fund' ? 'f_'+a.code : this.fmtCode(a.code);
                    const d = Engine.cache[k];
                    
                    if(d) {
                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        const flash = (a.lastP && a.lastP !== d.price) ? (d.price>a.lastP?'flash-up':'flash-down') : '';
                        a.lastP = d.price;
                        
                        // è¯¦æƒ…è¡Œï¼šæŒä»“æ˜¾ç¤ºç›ˆäºï¼Œè§‚æœ›æ˜¾ç¤ºæ¶¨è·Œ
                        let detailHtml = '';
                        if(this.viewList === 'holding') {
                            const val = (d.price * a.vol).toFixed(0);
                            const profitRate = a.cost>0 ? ((d.price-a.cost)/a.cost*100).toFixed(1)+'%' : '--';
                            detailHtml = `<span class="text-gray-500">å¸‚å€¼ ${val} | ç›ˆäº ${profitRate}</span>`;
                        } else {
                            detailHtml = `<span class="text-gray-500">å½“å‰ä»· ${d.price}</span>`;
                        }

                        list.innerHTML += `
                            <div class="p-3 flex justify-between items-center group relative overflow-hidden">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] px-1.5 py-0.5 rounded ${a.type==='fund'?'bg-orange-900/30 text-orange-400':'bg-blue-900/30 text-blue-400'} font-bold">${a.type==='fund'?'åŸº':'è‚¡'}</span>
                                        <span class="font-bold text-sm text-gray-200">${d.name}</span>
                                    </div>
                                    <div class="text-[10px] font-mono">${detailHtml}</div>
                                </div>
                                <div class="text-right px-2 rounded ${flash} transition-colors duration-500">
                                    <div class="font-bold font-mono text-sm text-white">${d.price}</div>
                                    <div class="text-[10px] ${color} font-bold">${d.rate>0?'+':''}${d.rate}%</div>
                                </div>
                                <button onclick="App.del(${realIdx})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-600 text-white flex items-center justify-center translate-x-full group-hover:translate-x-0 transition-transform">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                });
            },

            // --- äº¤äº’é€»è¾‘ ---
            switchList(type) {
                this.viewList = type;
                document.getElementById('tab-holding').className = type==='holding' ? 'flex-1 py-3 text-xs font-bold text-center tab-btn active' : 'flex-1 py-3 text-xs font-bold text-center tab-btn inactive';
                document.getElementById('tab-watching').className = type==='watching' ? 'flex-1 py-3 text-xs font-bold text-center tab-btn active' : 'flex-1 py-3 text-xs font-bold text-center tab-btn inactive';
                this.renderAssets();
            },

            openAdd() {
                const code = prompt("è¯·è¾“å…¥ä»£ç  (æ”¯æŒ 600519, 00700, AAPL, 001840)");
                if(!code) return;
                
                let type = 'stock';
                if(/^\d{6}$/.test(code) && (code.startsWith('00')||code.startsWith('01'))) type='fund';
                if(confirm(`${code} æ˜¯åŸºé‡‘å—? \n[ç¡®å®š] åŸºé‡‘\n[å–æ¶ˆ] è‚¡ç¥¨`)) type='fund';
                
                const list = this.viewList; // æ·»åŠ åˆ°å½“å‰è§†å›¾
                let cost=0, vol=0;
                
                if(list === 'holding') {
                    vol = prompt("æŒæœ‰æ•°é‡/ä»½é¢", "100") || 0;
                    cost = prompt("æŒä»“æˆæœ¬", "0") || 0;
                }

                this.assets.push({ code: code.toUpperCase(), type, list, vol: parseFloat(vol), cost: parseFloat(cost) });
                this.save();
                this.loop();
            },

            del(i) {
                if(confirm("åˆ é™¤æ­¤èµ„äº§?")) {
                    this.assets.splice(i, 1);
                    this.save();
                    this.renderAssets();
                }
            },

            save() { localStorage.setItem('azhi_assets_v9', JSON.stringify(this.assets)); },
            
            nav(page) {
                ['market','ai','settings'].forEach(p => document.getElementById('view-'+p).classList.add('hidden'));
                document.getElementById('view-'+page).classList.remove('hidden');
                document.querySelectorAll('.nav-icon').forEach(n => { n.classList.remove('text-blue-500'); n.classList.add('text-gray-600'); });
                document.getElementById('nav-'+page).classList.add('text-blue-500');
            },

            // --- è®¾ç½®é€»è¾‘ ---
            toggleAiInputs() {
                const p = document.getElementById('aiProvider').value;
                const grpEnd = document.getElementById('input-endpoint-group');
                const grpMod = document.getElementById('input-model-group');
                
                if(p === 'gemini') {
                    grpEnd.classList.add('hidden');
                    grpMod.classList.add('hidden'); // Gemini è‡ªåŠ¨å¼ºåˆ¶ç”¨ 1.5-flash
                } else if (p === 'deepseek') {
                    grpEnd.classList.add('hidden');
                    document.getElementById('aiEndpoint').value = 'https://api.deepseek.com/chat/completions';
                    grpMod.classList.remove('hidden');
                    document.getElementById('aiModel').value = 'deepseek-chat';
                } else { // custom
                    grpEnd.classList.remove('hidden');
                    grpMod.classList.remove('hidden');
                }
            },

            saveSettings() {
                const conf = {
                    provider: document.getElementById('aiProvider').value,
                    key: document.getElementById('aiKey').value.trim(),
                    endpoint: document.getElementById('aiEndpoint').value.trim(),
                    model: document.getElementById('aiModel').value.trim() || 'gemini-1.5-flash'
                };
                localStorage.setItem('azhi_ai_config', JSON.stringify(conf));
                AI.config = conf;
                this.renderAiStatus();
                alert("è®¾ç½®å·²ä¿å­˜ï¼æ­£åœ¨å°è¯•è¿æ¥...");
                this.nav('ai');
                AI.ask("ä½ å¥½ï¼Œè¿æ¥æµ‹è¯•");
            },

            renderAiStatus() {
                const p = AI.config.provider;
                const label = p === 'gemini' ? 'Gemini 1.5' : (p === 'deepseek' ? 'DeepSeek' : 'Custom');
                document.getElementById('aiProviderDisplay').innerText = `AI: ${label}`;
                document.getElementById('aiModelName').innerText = label;
            },

            clearData() {
                if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰èµ„äº§ï¼Ÿ")) {
                    localStorage.removeItem('azhi_assets_v9');
                    location.reload();
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
