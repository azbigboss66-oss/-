<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>åŸºç‹é˜¿ä¹‹ V8</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        :root { --bg: #000; --card: #121212; --border: #333; --red: #ff453a; --green: #30d158; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .no-scroll::-webkit-scrollbar { display: none; }
        
        .flash-red { animation: flashR 0.8s; }
        .flash-green { animation: flashG 0.8s; }
        @keyframes flashR { 0% { background: rgba(255, 69, 58, 0.4); } 100% { background: transparent; } }
        @keyframes flashG { 0% { background: rgba(48, 209, 88, 0.4); } 100% { background: transparent; } }
    </style>
</head>
<body class="flex flex-col h-screen w-full">

    <header class="h-12 flex items-center justify-between px-4 border-b border-[#222] bg-[#111] z-50">
        <div class="flex items-center gap-2">
            <div id="status" class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
            <h1 class="font-bold text-base">åŸºç‹é˜¿ä¹‹ <span class="text-[9px] bg-purple-900 text-purple-300 px-1 rounded">V8</span></h1>
        </div>
        <div class="text-[10px] text-gray-500" id="modelDisplay">Model: --</div>
    </header>

    <main class="flex-1 overflow-y-auto no-scroll pb-32 bg-black relative" id="main">
        
        <div id="view-market" class="p-3 space-y-3">
            <div class="bg-[#121212] p-4 rounded-xl border border-[#222]">
                <div class="flex justify-between items-baseline">
                    <span class="text-[10px] text-gray-500">ä»Šæ—¥é¢„ä¼°ç›ˆäº</span>
                    <span id="updateTime" class="text-[10px] text-gray-600">--:--:--</span>
                </div>
                <div class="flex items-baseline gap-2 mt-1">
                    <span id="dayPnL" class="text-3xl font-bold font-mono tracking-tight text-white">0.00</span>
                    <span id="totalAsset" class="text-xs font-mono text-gray-400">æ€»èµ„: 0</span>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="indices"></div>

            <div class="bg-[#121212] rounded-xl border border-[#222] min-h-[300px]">
                <div class="flex justify-between items-center p-3 border-b border-[#222]">
                    <span class="text-sm font-bold">æˆ‘çš„æŒä»“</span>
                    <button onclick="App.addDialog()" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold">æ·»åŠ </button>
                </div>
                <div id="list" class="divide-y divide-[#222]">
                    <div class="p-10 text-center text-gray-600 text-xs">
                        æš‚æ— æ•°æ®ã€‚è¯·ç‚¹å‡»å³ä¸Šè§’ã€Œæ·»åŠ ã€<br>è¾“å…¥ä»£ç å¦‚ 001840 æˆ– 600519
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ai" class="hidden flex flex-col h-full p-3 pb-0">
            <div class="flex-1 bg-[#121212] rounded-xl border border-[#222] flex flex-col overflow-hidden">
                <div class="h-8 bg-[#1a1a1a] flex items-center px-3 justify-between border-b border-[#222]">
                    <span class="text-[10px] text-gray-500">AI çŠ¶æ€</span>
                    <span class="text-[10px] text-yellow-500" id="aiStatus">å¾…æœº</span>
                </div>
                <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-3 no-scroll">
                    <div class="bg-[#222] p-2 rounded text-xs text-gray-300 w-fit">
                        æˆ‘æ˜¯é˜¿ä¹‹ã€‚å¦‚æœæŠ¥é”™ï¼Œè¯·å»ã€Œè®¾ç½®ã€åˆ‡æ¢æ¨¡å‹ã€‚æ¨èä½¿ç”¨ Gemini 1.5 Flashã€‚
                    </div>
                </div>
                <div class="p-3 border-t border-[#222] bg-[#111]">
                    <div class="flex gap-2 mb-2">
                        <button onclick="AI.ask('holdings')" class="flex-1 bg-blue-900/30 text-blue-400 py-2 rounded text-xs">è¯Šæ–­æŒä»“</button>
                        <button onclick="AI.ask('market')" class="flex-1 bg-purple-900/30 text-purple-400 py-2 rounded text-xs">é¢„æµ‹å¤§ç›˜</button>
                    </div>
                    <div class="flex gap-2">
                        <input id="aiInput" class="flex-1 bg-black border border-[#333] rounded p-2 text-xs text-white" placeholder="è¾“å…¥ Key æˆ– æé—®...">
                        <button onclick="AI.send()" class="text-blue-500 px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <div id="view-settings" class="hidden p-4 space-y-4">
            <div class="bg-[#121212] rounded-xl p-4 border border-[#222] space-y-4">
                <h3 class="font-bold text-gray-300 border-b border-[#222] pb-2">AI æ ¸å¿ƒé…ç½®</h3>
                
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">API Key</label>
                    <input id="apiKey" type="password" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white font-mono placeholder-gray-700" placeholder="AIza...">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">é€‰æ‹©æ¨¡å‹ (æŠ¥é”™è¯·æ¢ä¸€ä¸ª)</label>
                    <select id="modelSelect" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (æœ€æ–°/å…è´¹/æ¨è)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (æ›´å¼º)</option>
                        <option value="gemini-pro">Gemini 1.0 Pro (æ—§ç‰ˆ)</option>
                    </select>
                </div>

                <button onclick="App.saveSettings()" class="w-full bg-green-600 py-2 rounded text-xs font-bold text-white">ä¿å­˜å¹¶æµ‹è¯•</button>
                
                <div class="pt-4 border-t border-[#333]">
                    <button onclick="App.clearAssets()" class="w-full bg-red-900/30 text-red-500 py-2 rounded text-xs">é‡ç½®æ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full h-16 bg-[#111] border-t border-[#222] flex justify-around items-center z-50 pb-safe">
        <button onclick="App.switch('market')" class="w-1/3 flex flex-col items-center text-blue-500" id="nav-market">
            <i class="fas fa-chart-bar text-lg"></i><span class="text-[10px]">è¡Œæƒ…</span>
        </button>
        <button onclick="App.switch('ai')" class="w-1/3 flex flex-col items-center text-gray-600" id="nav-ai">
            <i class="fas fa-robot text-lg"></i><span class="text-[10px]">é˜¿ä¹‹</span>
        </button>
        <button onclick="App.switch('settings')" class="w-1/3 flex flex-col items-center text-gray-600" id="nav-settings">
            <i class="fas fa-cog text-lg"></i><span class="text-[10px]">è®¾ç½®</span>
        </button>
    </nav>

    <script>
        // === ğŸš€ è…¾è®¯è¡Œæƒ…å¼•æ“ ===
        const Engine = {
            cache: {},
            fetch(codes, cb) {
                const s = document.createElement('script');
                s.src = `https://qt.gtimg.cn/q=${codes}`;
                s.charset = 'gbk'; 
                s.onload = () => { this.parse(codes.split(',')); cb(true); s.remove(); };
                s.onerror = () => { cb(false); s.remove(); };
                document.head.appendChild(s);
            },
            fetchFund(code, cb) {
                const s = document.createElement('script');
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                const old = window.jsonpgz;
                window.jsonpgz = (data) => {
                    this.cache['f_'+code] = { name: data.name, price: +data.gsz, rate: +data.gszzl };
                    if(old) window.jsonpgz = old;
                    s.remove();
                    cb();
                };
                s.onerror = () => s.remove();
                document.head.appendChild(s);
            },
            parse(codes) {
                codes.forEach(c => {
                    const val = window['v_' + c];
                    if(!val) return;
                    const d = val.split('~');
                    this.cache[c] = { name: d[1], price: parseFloat(d[3]), rate: parseFloat(d[32]) };
                });
            }
        };

        const App = {
            assets: JSON.parse(localStorage.getItem('azhi_assets_v8') || '[]'),
            key: localStorage.getItem('azhi_key') || '',
            model: localStorage.getItem('azhi_model') || 'gemini-1.5-flash',
            timer: null,

            init() {
                if(this.key) document.getElementById('apiKey').value = this.key;
                document.getElementById('modelSelect').value = this.model;
                document.getElementById('modelDisplay').innerText = `Model: ${this.model.replace('gemini-','')}`;
                
                this.loop();
                this.timer = setInterval(() => this.loop(), 2000);
            },

            async loop() {
                const stocks = ['sh000001', 'sz399006', 'usNDAQ', 'hkHSI'];
                const myStocks = [];
                const myFunds = [];

                this.assets.forEach(a => {
                    if(a.type === 'fund') myFunds.push(a.code);
                    else myStocks.push(this.formatCode(a.code));
                });

                const q = [...stocks, ...myStocks].join(',');
                if(q) {
                    Engine.fetch(q, (ok) => {
                        document.getElementById('status').className = ok ? "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#0f0]" : "w-2 h-2 rounded-full bg-red-500";
                        this.render();
                    });
                }
                myFunds.forEach(c => Engine.fetchFund(c, () => this.render()));
                document.getElementById('updateTime').innerText = dayjs().format('HH:mm:ss');
            },

            formatCode(c) {
                if(/^[a-z]{2}/.test(c)) return c;
                if(/^\d{6}$/.test(c)) return (c.startsWith('6')?'sh':'sz') + c;
                if(/^\d{5}$/.test(c)) return 'hk' + c; 
                if(/^[A-Z]+$/.test(c)) return 'us' + c;
                return c;
            },

            render() {
                const idxMap = { 'sh000001':'ä¸Šè¯', 'sz399006':'åˆ›ä¸š', 'usNDAQ':'çº³æŒ‡', 'hkHSI':'æ’ç”Ÿ' };
                const idxDiv = document.getElementById('indices');
                idxDiv.innerHTML = '';
                Object.keys(idxMap).forEach(k => {
                    const d = Engine.cache[k];
                    if(d) {
                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        idxDiv.innerHTML += `<div class="bg-[#161616] p-2 rounded text-center border border-[#222]"><div class="text-[9px] text-gray-500">${idxMap[k]}</div><div class="font-bold text-xs mt-1 text-white">${d.price}</div><div class="text-[9px] ${color}">${d.rate}%</div></div>`;
                    }
                });

                const list = document.getElementById('list');
                list.innerHTML = '';
                let totalPnL = 0;
                let totalAsset = 0;

                if(this.assets.length === 0) list.innerHTML = `<div class="p-10 text-center text-gray-600 text-xs">æš‚æ— èµ„äº§ï¼Œè¯·ç‚¹å‡»æ·»åŠ </div>`;

                this.assets.forEach((a, i) => {
                    const key = a.type==='fund' ? 'f_'+a.code : this.formatCode(a.code);
                    const d = Engine.cache[key];
                    if(d) {
                        const val = d.price * a.vol;
                        const pnl = val * (d.rate/100) / (1 + d.rate/100);
                        totalPnL += pnl;
                        totalAsset += val;
                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        const flash = (a.lastP && a.lastP !== d.price) ? (d.price>a.lastP?'flash-red':'flash-green') : '';
                        a.lastP = d.price;

                        list.innerHTML += `
                            <div class="p-3 flex justify-between items-center group relative overflow-hidden">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] px-1 rounded ${a.type==='fund'?'bg-orange-900 text-orange-400':'bg-blue-900 text-blue-400'}">${a.type==='fund'?'åŸº':'è‚¡'}</span>
                                        <span class="font-bold text-sm text-gray-300">${d.name}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-600 mt-1">${a.code} | æŒ ${a.vol}</div>
                                </div>
                                <div class="text-right px-2 rounded ${flash}">
                                    <div class="font-bold font-mono text-sm text-gray-200">${d.price}</div>
                                    <div class="text-[10px] ${color}">${d.rate>0?'+':''}${d.rate}%</div>
                                </div>
                                <button onclick="App.del(${i})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-900 text-white translate-x-full group-hover:translate-x-0 transition-transform">åˆ </button>
                            </div>
                        `;
                    }
                });

                document.getElementById('dayPnL').innerText = (totalPnL>0?'+':'') + totalPnL.toFixed(2);
                document.getElementById('dayPnL').className = `text-3xl font-bold font-mono tracking-tight ${totalPnL>=0?'text-red-500':'text-green-500'}`;
                document.getElementById('totalAsset').innerText = `æ€»èµ„: ${Math.round(totalAsset)}`;
            },

            addDialog() {
                const code = prompt("è¾“å…¥ä»£ç  (æ”¯æŒ: 600519, 00700, AAPL, 001840)");
                if(!code) return;
                let type = 'stock';
                if(/^\d{6}$/.test(code) && (code.startsWith('00')||code.startsWith('01'))) type='fund';
                if(confirm(`${code} æ˜¯åŸºé‡‘å—? ç¡®å®š=åŸºé‡‘, å–æ¶ˆ=è‚¡ç¥¨`)) type='fund';
                const vol = prompt("æŒæœ‰æ•°é‡", "100");
                this.assets.push({ code, type, vol: parseFloat(vol)||0 });
                localStorage.setItem('azhi_assets_v8', JSON.stringify(this.assets));
                this.loop();
            },

            del(i) {
                if(confirm("åˆ é™¤?")) {
                    this.assets.splice(i, 1);
                    localStorage.setItem('azhi_assets_v8', JSON.stringify(this.assets));
                    this.render();
                }
            },

            saveSettings() {
                const k = document.getElementById('apiKey').value.trim();
                const m = document.getElementById('modelSelect').value;
                
                if(k) localStorage.setItem('azhi_key', k);
                localStorage.setItem('azhi_model', m);
                this.key = k;
                this.model = m;
                document.getElementById('modelDisplay').innerText = `Model: ${m.replace('gemini-','')}`;
                
                alert("è®¾ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨æµ‹è¯•è¿æ¥...");
                this.switch('ai');
                AI.ask('ping');
            },
            
            clearAssets() {
                localStorage.removeItem('azhi_assets_v8');
                this.assets = [];
                this.render();
            },

            switch(page) {
                ['market','ai','settings'].forEach(p => {
                    document.getElementById('view-'+p).className = p===page?'block h-full':'hidden';
                    const btn = document.getElementById('nav-'+p);
                    if(p===page) btn.className = "w-1/3 flex flex-col items-center text-blue-500";
                    else btn.className = "w-1/3 flex flex-col items-center text-gray-600";
                });
            }
        };

        const AI = {
            async ask(type) {
                if(!App.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key");
                
                document.getElementById('aiStatus').innerText = "è¿æ¥ä¸­...";
                document.getElementById('aiStatus').className = "text-[10px] text-yellow-500 animate-pulse";
                
                if(type !== 'ping') this.reply("User", type === 'holdings' ? "å¸®æˆ‘è¯Šæ–­æŒä»“" : "é¢„æµ‹å¤§ç›˜");
                
                // 1. æ•°æ®å‡†å¤‡
                const context = App.assets.map(a => {
                    const k = a.type==='fund' ? 'f_'+a.code : App.formatCode(a.code);
                    const d = Engine.cache[k];
                    return d ? `${d.name}:ç°ä»·${d.price},æ¶¨å¹…${d.rate}%` : a.code;
                }).join('; ');

                const prompt = type === 'ping' ? 'Hello' : `æˆ‘æ˜¯æ¿€è¿›æŠ•èµ„è€…ã€‚æŒä»“: [${context}]ã€‚è¯·æ¯’èˆŒç‚¹è¯„ã€‚`;
                
                // 2. å‘é€ (ä½¿ç”¨ Settings é‡Œé€‰ä¸­çš„æ¨¡å‹)
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${App.model}:generateContent?key=${App.key}`;
                    
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const json = await res.json();
                    if(json.error) throw new Error(json.error.message);
                    
                    const text = json.candidates[0].content.parts[0].text;
                    this.reply("é˜¿ä¹‹", type === 'ping' ? "è¿æ¥æˆåŠŸï¼ä½ çš„ Key å’Œç½‘ç»œéƒ½æ²¡é—®é¢˜ã€‚" : text);
                    document.getElementById('aiStatus').innerText = "åœ¨çº¿";
                    document.getElementById('aiStatus').className = "text-[10px] text-green-500";
                } catch(e) {
                    this.reply("Error", `å¤±è´¥: ${e.message}ã€‚è¯·å»è®¾ç½®åˆ‡æ¢æ¨¡å‹ï¼`);
                    document.getElementById('aiStatus').innerText = "ç¦»çº¿";
                    document.getElementById('aiStatus').className = "text-[10px] text-red-500";
                }
            },
            
            reply(role, text) {
                const box = document.getElementById('chatBox');
                const color = role === 'User' ? 'text-blue-400' : (role === 'Error' ? 'text-red-500' : 'text-gray-300');
                box.innerHTML += `
                    <div class="bg-[#222] p-2 rounded mb-2 text-xs ${color} border border-[#333]">
                        <b class="opacity-50">${role}:</b> ${marked.parse(text)}
                    </div>`;
                box.scrollTop = box.scrollHeight;
            },

            send() {
                const v = document.getElementById('aiInput').value;
                if(v) {
                    if(v.startsWith('AIza')) {
                        document.getElementById('apiKey').value = v;
                        App.saveSettings();
                        return;
                    }
                    AI.reply("User", v);
                    AI.ask('holdings'); 
                    document.getElementById('aiInput').value = '';
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
