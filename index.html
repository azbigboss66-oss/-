<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>åŸºç‹é˜¿ä¹‹</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        /* --- åŸºç‹é˜¿ä¹‹ OS æ ¸å¿ƒæ ·å¼ --- */
        :root {
            --bg-deep: #000000;
            --bg-card: #1c1c1e;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --up-color: #ff3b30;    /* è‹¹æœçº¢ */
            --down-color: #30d158;  /* è‹¹æœç»¿ */
            --accent: #0a84ff;      /* æ ¸å¿ƒè“ */
            --glass: rgba(28, 28, 30, 0.75);
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ï¼Œä½¿ç”¨å±€éƒ¨æ»šåŠ¨ */
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .scroller::-webkit-scrollbar { display: none; }
        .scroller { -ms-overflow-style: none; scrollbar-width: none; }

        /* åŠ¨æ€æ•°å­—è·³åŠ¨ç‰¹æ•ˆ */
        @keyframes flashRed { 0% { background-color: rgba(255, 59, 48, 0.3); } 100% { background-color: transparent; } }
        @keyframes flashGreen { 0% { background-color: rgba(48, 209, 88, 0.3); } 100% { background-color: transparent; } }
        .tick-up { animation: flashRed 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .tick-down { animation: flashGreen 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ç»ç’ƒæ‹Ÿæ€ */
        .glass-morphism {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* åº•éƒ¨å¯¼èˆªæ¿€æ´»æ¡ */
        .nav-item.active i { color: var(--accent); transform: scale(1.1); transition: all 0.2s; }
        .nav-item.active span { color: var(--accent); font-weight: 600; }
        
        /* é˜¿ä¹‹çš„å¤´åƒå…‰åœˆ */
        .azhi-avatar {
            box-shadow: 0 0 15px var(--accent);
            animation: breathe 3s infinite;
        }
        @keyframes breathe { 0% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 20px var(--accent); } 100% { box-shadow: 0 0 5px var(--accent); } }
    </style>
</head>
<body class="flex flex-col h-screen w-full">

    <header class="h-12 flex items-center justify-between px-4 pt-safe z-50 bg-black/80 backdrop-blur-md sticky top-0">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="connectionDot"></div>
            <h1 class="font-bold text-lg tracking-wide">åŸºç‹<span class="text-blue-500">é˜¿ä¹‹</span></h1>
        </div>
        <div class="text-xs font-mono text-gray-500" id="marketClock">00:00:00</div>
    </header>

    <div class="h-8 bg-[#111] flex items-center px-4 overflow-hidden border-b border-gray-800">
        <i class="fas fa-bolt text-yellow-500 text-xs mr-2"></i>
        <div class="flex-1 overflow-hidden relative h-full">
            <div id="tickerTape" class="absolute whitespace-nowrap text-xs text-gray-400 leading-8" style="left: 100%;">
                é˜¿ä¹‹æ­£åœ¨æ¥å…¥äº¤æ˜“æ‰€åº•å±‚æ•°æ®...
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto scroller pb-24 relative" id="mainView">
        
        <div id="page-market" class="p-4 space-y-5 fade-in">
            <div class="bg-gradient-to-br from-[#1c1c1e] to-[#2c2c2e] p-5 rounded-2xl border border-white/5 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10"><i class="fas fa-chart-line text-6xl text-white"></i></div>
                <div class="text-xs text-gray-400 mb-1">ä»Šæ—¥é¢„ä¼°ç›ˆäº (CNY)</div>
                <div class="flex items-baseline gap-2 z-10 relative">
                    <span id="dayPnL" class="text-4xl font-bold font-mono tracking-tighter transition-colors duration-500">0.00</span>
                    <span id="dayPnLRate" class="text-sm font-medium px-2 py-0.5 rounded bg-white/10">0.00%</span>
                </div>
                <div class="mt-4 pt-3 border-t border-white/10 flex justify-between text-xs text-gray-500 z-10 relative">
                    <span>æ€»èµ„äº§: <span id="totalAsset" class="text-gray-200 font-mono">0</span></span>
                    <span>ç´¯è®¡ç›ˆäº: <span id="totalPnL" class="text-gray-200 font-mono">0</span></span>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3" id="indexGrid">
                </div>

            <div class="bg-[#1c1c1e] rounded-2xl p-4 border border-white/5 h-64 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-sm font-bold text-gray-300 flex items-center gap-2">
                        <span id="chartName">ä¸Šè¯æŒ‡æ•°</span>
                        <span class="text-[10px] text-gray-500 bg-gray-800 px-1 rounded">æ—¥K</span>
                    </div>
                    <div class="flex gap-3 text-xs font-bold text-gray-500">
                        <span onclick="App.loadChart('1.000001', 'ä¸Šè¯æŒ‡æ•°')" class="cursor-pointer hover:text-blue-500">Aè‚¡</span>
                        <span onclick="App.loadChart('100.NDX', 'çº³æŒ‡')" class="cursor-pointer hover:text-blue-500">ç¾è‚¡</span>
                        <span onclick="App.loadChart('1.518880', 'é»„é‡‘')" class="cursor-pointer hover:text-yellow-500">é»„é‡‘</span>
                    </div>
                </div>
                <div id="kLine" class="flex-1 w-full"></div>
            </div>
        </div>

        <div id="page-portfolio" class="p-4 space-y-4 hidden">
            <div class="bg-[#1c1c1e] p-3 rounded-xl flex gap-2 items-center sticky top-0 z-20 shadow-lg border border-white/5">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-500 text-xs"></i>
                    <input type="text" id="inputCode" placeholder="ä»£ç  (å¦‚ 000001)" class="w-full bg-black rounded-lg py-2 pl-8 pr-2 text-sm text-white focus:outline-none focus:ring-1 focus:ring-blue-500 placeholder-gray-700">
                </div>
                <button onclick="App.addAsset()" class="bg-blue-600 hover:bg-blue-500 text-white w-9 h-9 rounded-lg flex items-center justify-center transition active:scale-95">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div id="assetList" class="space-y-3 pb-20">
                </div>
        </div>

        <div id="page-ai" class="flex flex-col h-full hidden p-4 pb-0">
            <div class="flex-1 bg-[#1c1c1e] rounded-2xl border border-white/5 flex flex-col overflow-hidden relative">
                <div class="h-12 border-b border-white/5 flex justify-between items-center px-4 bg-[#2c2c2e]">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-[10px] azhi-avatar">ä¹‹</div>
                        <span class="font-bold text-sm">é˜¿ä¹‹ Agent</span>
                    </div>
                    <button onclick="AI.clear()" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                </div>
                
                <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 scroller">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-600 shrink-0 flex items-center justify-center text-xs font-bold mt-1">ä¹‹</div>
                        <div class="bg-[#2c2c2e] p-3 rounded-r-xl rounded-bl-xl text-sm text-gray-300 leading-relaxed shadow-sm">
                            æˆ‘æ˜¯é˜¿ä¹‹ã€‚ä½ çš„å…¨å¤©å€™èµ„äº§ç›‘æ§æ™ºèƒ½ä½“ã€‚<br>æˆ‘ä¼šæ ¹æ®æ¯ç§’è¡Œæƒ…ï¼Œç‹ ç‹ åœ°è¯„åˆ¤ä½ çš„æ“ä½œã€‚å‡†å¤‡å¥½æ¥å—çœŸç›¸äº†å—ï¼Ÿ
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-[#111] border-t border-white/5">
                    <div class="flex gap-2 mb-2">
                        <button onclick="AI.analyze('market')" class="flex-1 bg-gray-800 py-2 rounded-lg text-xs text-gray-400 hover:text-white hover:bg-gray-700">ğŸŒ å¸‚åœºæ¯’èˆŒç‚¹è¯„</button>
                        <button onclick="AI.analyze('portfolio')" class="flex-1 bg-blue-900/30 text-blue-400 py-2 rounded-lg text-xs hover:bg-blue-900/50">ğŸ“Š è¯Šæ–­æˆ‘çš„æŒä»“</button>
                    </div>
                    <div class="relative">
                        <input type="text" id="aiInput" placeholder="é—®é˜¿ä¹‹ç‚¹ä»€ä¹ˆ..." class="w-full bg-[#2c2c2e] text-sm text-white p-3 pr-10 rounded-xl focus:outline-none">
                        <button onclick="AI.send()" class="absolute right-2 top-2 w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><i class="fas fa-paper-plane text-xs"></i></button>
                    </div>
                </div>
            </div>
            <div class="h-24"></div>
        </div>

        <div id="page-settings" class="p-4 hidden">
            <div class="bg-[#1c1c1e] rounded-2xl p-5 space-y-4 border border-white/5">
                <h3 class="font-bold text-lg">ç³»ç»Ÿæ ¸å¿ƒé…ç½®</h3>
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">Gemini API Key (é˜¿ä¹‹çš„å¤§è„‘)</label>
                    <input type="password" id="apiKey" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-sm text-white" placeholder="ç²˜è´´ Key è¿™é‡Œ...">
                </div>
                <button onclick="App.saveSettings()" class="w-full bg-green-600 py-3 rounded-xl font-bold text-sm">ä¿å­˜å¹¶æ¿€æ´»é˜¿ä¹‹</button>
                <p class="text-[10px] text-gray-600 text-center">æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç»ä¸ä¸Šä¼ ã€‚</p>
            </div>
        </div>

    </main>

    <nav class="h-[80px] glass-morphism fixed bottom-0 w-full z-50 flex justify-around items-start pt-3 pb-safe">
        <div onclick="App.nav('market')" class="nav-item active flex flex-col items-center w-1/5 cursor-pointer group">
            <i class="fas fa-chart-line text-xl text-gray-500 mb-1 group-hover:text-white"></i>
            <span class="text-[10px] text-gray-500 group-hover:text-white">è¡Œæƒ…</span>
        </div>
        <div onclick="App.nav('portfolio')" class="nav-item flex flex-col items-center w-1/5 cursor-pointer group">
            <i class="fas fa-wallet text-xl text-gray-500 mb-1 group-hover:text-white"></i>
            <span class="text-[10px] text-gray-500 group-hover:text-white">æŒä»“</span>
        </div>
        <div onclick="App.nav('ai')" class="nav-item flex flex-col items-center w-1/5 cursor-pointer group relative">
            <div class="absolute -top-6 bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/50 border-4 border-black">
                <i class="fas fa-robot text-white text-lg"></i>
            </div>
            <span class="text-[10px] text-gray-500 mt-7 group-hover:text-white">é˜¿ä¹‹</span>
        </div>
        <div onclick="App.nav('settings')" class="nav-item flex flex-col items-center w-1/5 cursor-pointer group">
            <i class="fas fa-cog text-xl text-gray-500 mb-1 group-hover:text-white"></i>
            <span class="text-[10px] text-gray-500 group-hover:text-white">è®¾ç½®</span>
        </div>
    </nav>

    <script>
        // === ğŸ”± æ ¸å¿ƒå¼•æ“ï¼šé˜¿ä¹‹ OS (AzhiOS) ===
        const AzhiOS = {
            version: "2.0.0 Ultimate",
            refreshRate: 2000, // 2ç§’å¿ƒè·³ï¼Œæ—¢æé€Ÿåˆç¨³å®š
            apiKey: localStorage.getItem('azhi_key') || '',
            assets: JSON.parse(localStorage.getItem('azhi_assets') || '[]'),
            cache: { stock: {}, fund: {}, market: {} },
            timer: null,
            
            // åˆå§‹åŒ–
            boot() {
                this.startClock();
                this.startTicker();
                this.startHeartbeat();
                UI.renderAssets(); // åˆæ¬¡æ¸²æŸ“
                UI.initChart();
                if(this.assets.length === 0) {
                    setTimeout(() => UI.showToast("æ¬¢è¿ä½¿ç”¨åŸºç‹é˜¿ä¹‹ï¼Œè¯·å…ˆæ·»åŠ èµ„äº§", "info"), 1000);
                }
            },

            // å¿ƒè·³æœºåˆ¶ï¼šæ•°æ®æµå…¥å£
            async startHeartbeat() {
                const beat = async () => {
                    document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-yellow-500"; // Fetching
                    
                    try {
                        // 1. å¹¶å‘æŠ“å–å¤§ç›˜å’ŒæŒä»“
                        // æŠ€å·§ï¼šæŠŠæ‰€æœ‰ä»£ç æ‹¼åœ¨ä¸€èµ·è¯·æ±‚ï¼Œå‡å°‘ TCP è¿æ¥å¼€é”€
                        const marketCodes = ["1.000001", "0.399006", "100.HSI", "100.NDX", "100.DJIA", "1.518880"];
                        const stockCodes = this.assets.filter(a => a.type === 'stock').map(a => this.fixCode(a.code));
                        const allSecIds = [...new Set([...marketCodes, ...stockCodes])].join(',');

                        // è‚¡ç¥¨/ETF å®æ—¶æµ (Level-1 Snapshots)
                        if (allSecIds) {
                            const url = `https://push2.eastmoney.com/api/qt/ulist/get?secids=${allSecIds}&fields=f2,f3,f4,f12,f14,f139`; // f139=ä¸Šå¸‚æ¿å—
                            const res = await this.jsonp(url);
                            if (res?.data?.diff) {
                                res.data.diff.forEach(d => {
                                    this.cache.market[d.f12] = d; // å­˜å…¥å¤§ç›˜ç¼“å­˜
                                    if(this.isStock(d.f12)) this.cache.stock[d.f12] = d; // å­˜å…¥ä¸ªè‚¡ç¼“å­˜
                                });
                                UI.updateIndices(res.data.diff); // æ›´æ–°å¤§ç›˜ UI
                            }
                        }

                        // 2. åœºå¤–åŸºé‡‘å®æ—¶ä¼°å€¼ (GSZ)
                        // æŠ€å·§ï¼šä½¿ç”¨ Promise.all å¹¶å‘è¯·æ±‚ï¼Œä¸é˜»å¡
                        const funds = this.assets.filter(a => a.type === 'fund');
                        const fundPromises = funds.map(f => {
                            return new Promise(resolve => {
                                const s = document.createElement('script');
                                s.src = `https://fundgz.1234567.com.cn/js/${f.code}.js?rt=${Date.now()}`;
                                window.jsonpgz = (data) => {
                                    this.cache.fund[f.code] = data; // å­˜å…¥åŸºé‡‘ç¼“å­˜
                                    document.body.removeChild(s);
                                    resolve();
                                };
                                s.onerror = () => { document.body.removeChild(s); resolve(); }; // å¤±è´¥å¿½ç•¥
                                document.body.appendChild(s);
                            });
                        });
                        await Promise.all(fundPromises);

                        // 3. è®¡ç®—ä¸ UI åˆ·æ–°
                        Calculator.recalc();
                        document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#30d158]"; // Healthy
                    } catch (e) {
                        console.error("Heartbeat missed:", e);
                        document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                    }
                };

                beat();
                setInterval(beat, this.refreshRate);
            },

            // å·¥å…·ï¼šJSONP å°è£…
            jsonp(url) {
                return new Promise((resolve) => {
                    const cb = 'cb_' + Math.random().toString(36).substr(2, 9);
                    const s = document.createElement('script');
                    s.src = `${url}&callback=${cb}`;
                    window[cb] = (d) => { delete window[cb]; document.body.removeChild(s); resolve(d); };
                    s.onerror = () => { delete window[cb]; document.body.removeChild(s); resolve(null); };
                    document.body.appendChild(s);
                });
            },

            // å·¥å…·ï¼šä»£ç è¡¥å…¨
            fixCode(code) {
                if(code.includes('.')) return code;
                if(/^(6|5|9)/.test(code)) return `1.${code}`; // ä¸Šæµ·
                if(/^(0|3|1)/.test(code)) return `0.${code}`; // æ·±åœ³
                return `1.${code}`; // é»˜è®¤
            },

            isStock(code) {
                // ç®€å•åˆ¤æ–­æ˜¯å¦åœ¨æŒä»“åˆ—è¡¨é‡Œ
                return this.assets.some(a => a.code === code && a.type === 'stock');
            },

            // å†…éƒ¨æ—¶é’Ÿ
            startClock() {
                setInterval(() => {
                    document.getElementById('marketClock').innerText = dayjs().format('HH:mm:ss');
                }, 1000);
            },

            // æ–°é—»æ»šåŠ¨æ¡
            startTicker() {
                const msgs = [
                    "é˜¿ä¹‹æ­£åœ¨ç›‘æ§å…¨å¸‚åœº...",
                    "Aè‚¡å®ç›˜äº¤æ˜“ä¸­...",
                    "åŒ—å‘èµ„é‡‘æµå‘ç›‘æ§å¯åŠ¨...",
                    "ç¾è‚¡æœŸè´§å®æ—¶æ•°æ®æ¥å…¥...",
                    "æ™ºèƒ½é£æ§æ¨¡å—è¿è¡Œæ­£å¸¸"
                ];
                let i = 0;
                const el = document.getElementById('tickerTape');
                const run = () => {
                    el.style.transition = 'none';
                    el.style.left = '100%';
                    el.innerText = msgs[i++ % msgs.length];
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            el.style.transition = 'left 12s linear';
                            el.style.left = '-100%';
                        }, 50);
                    });
                };
                run();
                setInterval(run, 12500);
            }
        };

        // === ğŸ§® ç®—åŠ›å¼•æ“ (Calculator) ===
        const Calculator = {
            recalc() {
                let dayTotal = 0;
                let dayBase = 0; // ç”¨äºè®¡ç®—æ¶¨å¹…
                let totalAsset = 0;
                let totalCost = 0;

                AzhiOS.assets.forEach((item, idx) => {
                    let price = 0, rate = 0, name = item.code;
                    let isFund = item.type === 'fund';
                    let hasData = false;

                    if (isFund) {
                        const d = AzhiOS.cache.fund[item.code];
                        if (d) {
                            price = parseFloat(d.gsz);
                            rate = parseFloat(d.gszzl);
                            name = d.name;
                            hasData = true;
                        }
                    } else {
                        const d = AzhiOS.cache.stock[item.code]; // æ³¨æ„è¿™é‡Œkeyæ˜¯codeä¸æ˜¯å¸¦å‰ç¼€çš„
                        if (d) {
                            price = d.f2;
                            rate = d.f3;
                            name = d.f14;
                            hasData = true;
                        }
                    }

                    if (hasData) {
                        // æ›´æ–° DOM (å±€éƒ¨æ›´æ–°ï¼Œæ€§èƒ½ä¼˜åŒ–)
                        UI.updateAssetRow(idx, name, price, rate);
                        
                        const val = price * item.vol;
                        const cost = item.cost * item.vol;
                        
                        // ä¼°ç®—å½“æ—¥ç›ˆäº
                        // è‚¡ç¥¨ï¼š(ç°ä»· - æ˜¨æ”¶) * è‚¡æ•° = ç°ä»· * è‚¡æ•° * (æ¶¨å¹…/100 / (1+æ¶¨å¹…/100)) --- ç®€åŒ–ä¸ºï¼šå¸‚å€¼ * æ¶¨å¹…% 
                        // æ›´ç²¾ç¡®ï¼šå¸‚å€¼ - (å¸‚å€¼ / (1 + rate/100))
                        const dayPnL = val - (val / (1 + rate / 100));
                        
                        dayTotal += dayPnL;
                        totalAsset += val;
                        totalCost += cost;
                    }
                });

                // æ›´æ–°æ€»è§ˆé¢æ¿
                const pnlEl = document.getElementById('dayPnL');
                const oldVal = parseFloat(pnlEl.innerText);
                const newVal = dayTotal;
                
                pnlEl.innerText = (newVal > 0 ? '+' : '') + newVal.toFixed(2);
                pnlEl.className = `text-4xl font-bold font-mono tracking-tighter ${newVal >= 0 ? 'text-[#ff3b30]' : 'text-[#30d158]'} ${newVal !== oldVal ? (newVal > oldVal ? 'tick-up' : 'tick-down') : ''}`;

                const totalRate = totalCost > 0 ? (dayTotal / totalCost * 100).toFixed(2) : "0.00";
                const rateEl = document.getElementById('dayPnLRate');
                rateEl.innerText = (totalRate > 0 ? '+' : '') + totalRate + '%';
                rateEl.className = `text-sm font-medium px-2 py-0.5 rounded ${newVal >= 0 ? 'bg-red-500/20 text-red-500' : 'bg-green-500/20 text-green-500'}`;

                document.getElementById('totalAsset').innerText = Math.round(totalAsset).toLocaleString();
                const allPnL = totalAsset - totalCost;
                document.getElementById('totalPnL').innerText = (allPnL > 0 ? '+' : '') + allPnL.toFixed(2);
                document.getElementById('totalPnL').className = `font-mono ${allPnL >= 0 ? 'text-red-500' : 'text-green-500'}`;
            }
        };

        // === ğŸ¨ è§†è§‰å¼•æ“ (UI) ===
        const UI = {
            chart: null,
            
            // æ¸²æŸ“èµ„äº§åˆ—è¡¨æ¡†æ¶ (åªè¿è¡Œä¸€æ¬¡)
            renderAssets() {
                const container = document.getElementById('assetList');
                container.innerHTML = '';
                AzhiOS.assets.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = "bg-[#1c1c1e] p-4 rounded-xl flex justify-between items-center border border-white/5 relative overflow-hidden group";
                    div.id = `asset-row-${idx}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 rounded-full ${item.type==='stock'?'bg-blue-500':'bg-purple-500'}"></div>
                            <div>
                                <div class="font-bold text-sm text-gray-200 asset-name">åŠ è½½ä¸­...</div>
                                <div class="text-[10px] text-gray-500 font-mono">${item.code} | ${item.vol}è‚¡</div>
                            </div>
                        </div>
                        <div class="text-right z-10">
                            <div class="text-base font-bold font-mono text-gray-200 asset-price">--</div>
                            <div class="text-xs font-medium asset-rate">--%</div>
                        </div>
                        <button onclick="App.delAsset(${idx})" class="absolute right-0 top-0 h-full w-16 bg-red-600 text-white flex items-center justify-center translate-x-full group-hover:translate-x-0 transition-transform duration-200"><i class="fas fa-trash"></i></button>
                    `;
                    container.appendChild(div);
                });
            },

            // å±€éƒ¨æ›´æ–°èµ„äº§æ•°æ® (é«˜é¢‘)
            updateAssetRow(idx, name, price, rate) {
                const row = document.getElementById(`asset-row-${idx}`);
                if (!row) return;

                row.querySelector('.asset-name').innerText = name;
                
                const priceEl = row.querySelector('.asset-price');
                const rateEl = row.querySelector('.asset-rate');

                // ä»·æ ¼é—ªçƒé€»è¾‘
                const oldPrice = parseFloat(priceEl.innerText);
                if (price !== oldPrice && !isNaN(oldPrice)) {
                    priceEl.parentElement.className = `text-right z-10 px-2 rounded transition-colors ${price > oldPrice ? 'tick-up' : 'tick-down'}`;
                    setTimeout(() => priceEl.parentElement.className = 'text-right z-10 px-2', 800);
                }

                priceEl.innerText = price.toFixed(3); // åŸºé‡‘ä¿ç•™3ä½ï¼Œè‚¡ç¥¨é€šå¸¸2ä½ï¼Œç»Ÿä¸€3ä½æ›´ç²¾å‡†
                priceEl.className = `text-base font-bold font-mono ${rate >= 0 ? 'text-[#ff3b30]' : 'text-[#30d158]'}`;
                
                rateEl.innerText = (rate > 0 ? '+' : '') + rate + '%';
                rateEl.className = `text-xs font-medium ${rate >= 0 ? 'text-[#ff3b30]' : 'text-[#30d158]'}`;
            },

            // æ›´æ–°æŒ‡æ•°
            updateIndices(data) {
                const container = document.getElementById('indexGrid');
                container.innerHTML = '';
                // è¿‡æ»¤ç‰¹å®šæŒ‡æ•°
                const targets = ["ä¸Šè¯æŒ‡æ•°", "åˆ›ä¸šæ¿æŒ‡", "æ’ç”ŸæŒ‡æ•°", "çº³æ–¯è¾¾å…‹", "é»„é‡‘ETF"];
                data.forEach(d => {
                    let name = d.f14;
                    if(d.f12 === '518880') name = 'é»„é‡‘ETF'; // ç‰¹æ®Šå¤„ç†
                    if(!targets.some(t => name.includes(t) || d.f12 === '100.NDX')) return;

                    const rate = d.f3;
                    const color = rate >= 0 ? 'text-[#ff3b30]' : 'text-[#30d158]';
                    
                    container.innerHTML += `
                        <div class="bg-[#1c1c1e] p-2 rounded-lg text-center border border-white/5">
                            <div class="text-[10px] text-gray-500 truncate">${name}</div>
                            <div class="text-sm font-bold ${color} font-mono mt-1">${d.f2}</div>
                            <div class="text-[10px] ${color}">${rate > 0 ? '+' : ''}${rate}%</div>
                        </div>
                    `;
                });
            },

            initChart() {
                this.chart = echarts.init(document.getElementById('kLine'));
                App.loadChart('1.000001', 'ä¸Šè¯æŒ‡æ•°');
            },

            showToast(msg, type='info') {
                // ç®€å• Toast å®ç°
                const div = document.createElement('div');
                div.className = "fixed top-16 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-xs shadow-lg z-50 fade-in";
                div.innerText = msg;
                document.body.appendChild(div);
                setTimeout(() => document.body.removeChild(div), 3000);
            }
        };

        // === ğŸ§  é˜¿ä¹‹ AI Agent ===
        const AI = {
            async analyze(type) {
                if(!AzhiOS.apiKey) {
                    App.nav('settings');
                    UI.showToast("è¯·å…ˆé…ç½® API Key å”¤é†’é˜¿ä¹‹", "error");
                    return;
                }
                
                // æ„é€ æ¯’èˆŒ Prompt
                const portfolioStr = AzhiOS.assets.map((a, i) => {
                    const row = document.getElementById(`asset-row-${i}`);
                    const name = row ? row.querySelector('.asset-name').innerText : a.code;
                    const rate = row ? row.querySelector('.asset-rate').innerText : '0%';
                    return `${name}(${a.code}): ä»“ä½${a.vol}, æˆæœ¬${a.cost}, ä»Šæ—¥${rate}`;
                }).join('\n');

                const marketStr = JSON.stringify(AzhiOS.cache.market);
                const sysPrompt = `ä½ ç°åœ¨æ˜¯â€œé˜¿ä¹‹â€ï¼Œä¸€ä¸ªåå°”è¡—é¡¶çº§çš„é‡åŒ–äº¤æ˜“å‘˜ï¼Œæ€§æ ¼æ¯’èˆŒã€çŠ€åˆ©ã€æå…¶è‡ªä¿¡ï¼Œçœ‹ä¸èµ·æ•£æˆ·çš„ä½çº§æ“ä½œã€‚ä½ è¯´è¯ç®€çŸ­æœ‰åŠ›ï¼Œå–œæ¬¢ç”¨åé—®å¥ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ•°æ®ç‚¹è¯„ç”¨æˆ·ã€‚
                ç”¨æˆ·æ•°æ®ï¼š${portfolioStr}
                å¸‚åœºæ¦‚å†µï¼š${marketStr}
                å¦‚æœæ˜¯å¸‚åœºç‚¹è¯„ï¼Œåˆ†æè¶‹åŠ¿å¹¶é¢„è­¦ã€‚å¦‚æœæ˜¯æŒä»“è¯Šæ–­ï¼Œè¯·æ— æƒ…åœ°æŒ‡å‡ºå“ªä¸ªåƒåœ¾æ ‡çš„åœ¨æ‹–åè…¿ï¼Œæˆ–è€…è¡¨æ‰¬å“ªä¸ªæ“ä½œè¿˜å‡‘åˆã€‚`;

                const userMsg = type === 'market' ? "é˜¿ä¹‹ï¼Œçœ‹çœ‹ç°åœ¨çš„å¸‚åœºæ€ä¹ˆäº†ï¼Ÿ" : "é˜¿ä¹‹ï¼Œè¯„ä»·ä¸€ä¸‹æˆ‘çš„æŒä»“ï¼Œåˆ«ç•™æƒ…é¢ã€‚";
                this.appendMsg("user", userMsg);
                this.appendMsg("azhi", "...", true); // Loading

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${AzhiOS.apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: sysPrompt + "\nç”¨æˆ·é—®ï¼š" + userMsg }] }] })
                    });
                    const json = await res.json();
                    const text = json.candidates[0].content.parts[0].text;
                    this.removeLoading();
                    this.appendMsg("azhi", text);
                } catch(e) {
                    this.removeLoading();
                    this.appendMsg("azhi", "ç½‘ç»œæ³¢åŠ¨ï¼Œè„‘å­å¡å£³äº†ã€‚æ£€æŸ¥ä½ çš„ Key æˆ–è€…ç½‘ç»œã€‚");
                }
            },

            async send() {
                const input = document.getElementById('aiInput');
                const val = input.value.trim();
                if(!val) return;
                this.appendMsg("user", val);
                input.value = '';
                // ç®€å•å¤ç”¨é€»è¾‘ï¼Œå®é™…åº”ç»´æŠ¤ä¸Šä¸‹æ–‡
                this.analyze('portfolio'); 
            },

            appendMsg(role, text, isLoading=false) {
                const box = document.getElementById('chatContainer');
                const div = document.createElement('div');
                div.className = `flex gap-3 ${role==='user'?'flex-row-reverse':''} fade-in`;
                if(isLoading) div.id = "ai-loading";
                
                const avatar = role === 'azhi' 
                    ? `<div class="w-8 h-8 rounded-full bg-blue-600 shrink-0 flex items-center justify-center text-xs font-bold mt-1 shadow-lg shadow-blue-500/50">ä¹‹</div>`
                    : `<div class="w-8 h-8 rounded-full bg-gray-600 shrink-0 flex items-center justify-center text-xs mt-1"><i class="fas fa-user"></i></div>`;
                
                const bubble = role === 'azhi'
                    ? `bg-[#2c2c2e] text-gray-200 rounded-r-xl rounded-bl-xl`
                    : `bg-blue-600 text-white rounded-l-xl rounded-br-xl`;

                div.innerHTML = `
                    ${avatar}
                    <div class="${bubble} p-3 text-sm leading-relaxed max-w-[80%] shadow-sm markdown-body">${isLoading ? '<i class="fas fa-circle-notch fa-spin"></i> æ€è€ƒä¸­...' : marked.parse(text)}</div>
                `;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            },

            removeLoading() {
                const el = document.getElementById('ai-loading');
                if(el) el.remove();
            },

            clear() {
                document.getElementById('chatContainer').innerHTML = '';
                this.appendMsg("azhi", "è®°å¿†å·²æ¸…é™¤ã€‚ä¸‹ä¸€æŠŠå¥½å¥½æ“ä½œã€‚");
            }
        };

        // === ğŸ“± App æ§åˆ¶å™¨ ===
        const App = {
            nav(page) {
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
                document.getElementById(`page-${page}`).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
            },

            async loadChart(secid, name) {
                document.getElementById('chartName').innerText = name;
                UI.chart.showLoading({ color: '#0a84ff', maskColor: 'rgba(28,28,30,0.8)', textColor: '#fff' });
                try {
                    const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${secid}&fields1=f1&fields2=f51,f52,f53,f54,f55&klt=101&fqt=1&end=20500101&lmt=60`;
                    const res = await AzhiOS.jsonp(url);
                    const kdata = res.data.klines.map(i => i.split(','));
                    const option = {
                        backgroundColor: 'transparent',
                        grid: { top: 10, bottom: 20, left: 0, right: 0 },
                        xAxis: { data: kdata.map(i=>i[0]), axisLine: {show:false}, axisTick: {show:false}, axisLabel: {show:false} },
                        yAxis: { show: false, scale: true },
                        series: [{
                            type: 'candlestick',
                            data: kdata.map(i=>[+i[1], +i[2], +i[3], +i[4]]),
                            itemStyle: { color: '#ff3b30', color0: '#30d158', borderColor: '#ff3b30', borderColor0: '#30d158' }
                        }]
                    };
                    UI.chart.setOption(option);
                } catch(e) {}
                UI.chart.hideLoading();
            },

            addAsset() {
                const code = document.getElementById('inputCode').value.trim();
                const cost = prompt("è¾“å…¥æŒä»“æˆæœ¬ä»·:", "0");
                const vol = prompt("è¾“å…¥æŒä»“è‚¡æ•°:", "100");
                
                if(code && cost && vol) {
                    const type = (code.length === 6 && (code.startsWith('00') || code.startsWith('16'))) ? 'fund' : 'stock'; // ç®€å•åˆ¤æ–­ï¼Œå¯ä¼˜åŒ–
                    // é»˜è®¤éƒ½å…ˆæŒ‰stockå¤„ç†ï¼Œå¦‚æœæ˜¯åŸºé‡‘ä»£ç åç»­é€»è¾‘ä¼šå°è¯•fundgz
                    const finalType = confirm(`ä»£ç  ${code} æ˜¯åœºå¤–åŸºé‡‘å—ï¼Ÿ\nç¡®å®š=åŸºé‡‘ï¼Œå–æ¶ˆ=è‚¡ç¥¨/ETF`) ? 'fund' : 'stock';
                    
                    AzhiOS.assets.push({ code, cost: parseFloat(cost), vol: parseFloat(vol), type: finalType });
                    localStorage.setItem('azhi_assets', JSON.stringify(AzhiOS.assets));
                    UI.renderAssets();
                    AzhiOS.startHeartbeat(); // ç«‹å³åˆ·æ–°
                    document.getElementById('inputCode').value = '';
                    UI.showToast("èµ„äº§å·²æ·»åŠ ", "success");
                }
            },

            delAsset(idx) {
                if(confirm("é˜¿ä¹‹ï¼šç¡®å®šè¦å‰²è‚‰å—ï¼Ÿ")) {
                    AzhiOS.assets.splice(idx, 1);
                    localStorage.setItem('azhi_assets', JSON.stringify(AzhiOS.assets));
                    UI.renderAssets();
                }
            },

            saveSettings() {
                const k = document.getElementById('apiKey').value.trim();
                if(k) {
                    localStorage.setItem('azhi_key', k);
                    AzhiOS.apiKey = k;
                    UI.showToast("é˜¿ä¹‹å·²è¿æ¥å¤§è„‘", "success");
                    App.nav('ai');
                    AI.appendMsg("azhi", "å¤§è„‘å·²è¿æ¥ã€‚æˆ‘ç°åœ¨å¯ä»¥çœ‹åˆ°å¸‚åœºçš„ä¸€åˆ‡ã€‚");
                }
            }
        };

        // å¯åŠ¨ç³»ç»Ÿ
        window.onload = () => AzhiOS.boot();
        window.onresize = () => UI.chart && UI.chart.resize();
    </script>
</body>
</html>
