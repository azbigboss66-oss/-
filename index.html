<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>基王阿之 V10·上帝之眼</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>

    <style>
        /* --- V10 金融终端 UI 系统 --- */
        :root { 
            --bg-deep: #050505; --bg-card: #141414; --border: #262626; 
            --red: #FF3B30; --green: #30D158; --gold: #FFD700; --blue: #0A84FF;
        }
        body { background: var(--bg-deep); color: #e5e5e5; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        .no-scroll::-webkit-scrollbar { display: none; }
        
        /* 毫秒级跳动动画 */
        .tick-up { animation: flashRed 0.4s ease-out; }
        .tick-down { animation: flashGreen 0.4s ease-out; }
        @keyframes flashRed { 0% { background: rgba(255, 59, 48, 0.4); color: #fff; } 100% { background: transparent; } }
        @keyframes flashGreen { 0% { background: rgba(48, 209, 88, 0.4); color: #fff; } 100% { background: transparent; } }

        /* 玻璃态 */
        .glass { background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); }
        .glass-card { background: rgba(30, 30, 30, 0.4); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }

        /* 导航激活 */
        .nav-btn.active { color: var(--blue); transform: translateY(-2px); }
        .nav-btn.active i { filter: drop-shadow(0 0 5px rgba(10, 132, 255, 0.5)); }
        
        /* 加载动画 */
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen w-full">

    <header class="h-12 flex items-center justify-between px-4 bg-[#0a0a0a] border-b border-[#222] z-50 shrink-0">
        <div class="flex items-center gap-2">
            <div id="statusDot" class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
            <h1 class="font-bold text-base tracking-wide text-gray-100">基王<span class="text-blue-500">阿之</span> <span class="text-[9px] bg-gold text-black px-1 rounded font-bold">GOD_MODE</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="marketStatus" class="text-[10px] text-gray-500 border border-[#333] px-2 py-0.5 rounded">闭市中</div>
            <i onclick="App.refresh()" class="fas fa-sync-alt text-xs text-gray-500 active:rotate-180 transition-transform"></i>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scroll pb-24 bg-black relative" id="mainView">
        
        <div id="view-home" class="p-3 space-y-4 fade-in">
            
            <div class="bg-gradient-to-br from-[#1c1c1e] to-[#000] p-5 rounded-2xl border border-[#222] shadow-2xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-blue-600/10 rounded-full blur-3xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">今日实盘盈亏</div>
                            <div class="flex items-baseline gap-2">
                                <span id="dayPnL" class="text-4xl font-bold font-mono text-white tracking-tighter transition-all">0.00</span>
                                <span id="dayPnLRate" class="text-xs font-bold px-1.5 py-0.5 rounded bg-[#222] text-gray-500">0.00%</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">总资产</div>
                            <div id="totalAsset" class="text-lg font-mono font-bold text-gray-300">0</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-[#222]">
                        <div class="flex justify-between items-center text-[10px] mb-1">
                            <span class="text-gray-500">主力净流入</span>
                            <span id="mainFlow" class="font-mono text-gray-300">--</span>
                        </div>
                        <div class="w-full h-1 bg-[#222] rounded-full overflow-hidden">
                            <div id="flowBar" class="h-full bg-gray-500 w-1/2 transition-all duration-1000"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2" id="indexGrid">
                </div>

            <div class="bg-[#141414] rounded-xl border border-[#222] overflow-hidden min-h-[300px]">
                <div class="flex border-b border-[#222] bg-[#1a1a1a]">
                    <button onclick="App.switchList('holding')" id="tab-holding" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-blue-500 text-white">实盘持仓</button>
                    <button onclick="App.switchList('watching')" id="tab-watching" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-500">暗中观察</button>
                </div>
                <div id="assetList" class="divide-y divide-[#222]">
                    <div class="p-10 text-center text-gray-700 text-xs">加载数据引擎中...</div>
                </div>
                <div class="p-3 border-t border-[#222] bg-[#111]">
                    <button onclick="App.openAdd()" class="w-full bg-[#1a1a1a] hover:bg-[#222] text-blue-500 py-2 rounded-lg text-xs font-bold border border-blue-900/30 dashed">
                        <i class="fas fa-plus"></i> 添加资产 (股票/基金/美股)
                    </button>
                </div>
            </div>
        </div>

        <div id="view-report" class="hidden p-4 space-y-4 fade-in">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold text-gray-100">阿之财报中心</h2>
                <button onclick="Report.generate()" class="bg-blue-600 px-3 py-1 rounded text-xs text-white shadow-lg shadow-blue-500/30">
                    <i class="fas fa-magic"></i> 生成今日简报
                </button>
            </div>
            
            <div id="reportCard" class="bg-[#141414] border border-[#222] rounded-xl p-4 min-h-[400px]">
                <div class="text-center text-gray-600 mt-20 text-xs">
                    <i class="fas fa-newspaper text-4xl mb-4 opacity-20"></i><br>
                    点击生成按钮<br>AI 将聚合全球行情为您播报
                </div>
            </div>
        </div>

        <div id="view-ai" class="hidden flex flex-col h-full p-0 fade-in">
            <div class="h-10 bg-[#141414] border-b border-[#222] flex justify-between items-center px-4">
                <div class="text-xs text-gray-400 flex items-center gap-2">
                    <span id="aiModelBadge" class="bg-purple-900/50 text-purple-300 px-1.5 py-0.5 rounded text-[9px]">OFFLINE</span>
                </div>
                <button onclick="AI.clear()" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
            </div>
            
            <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 no-scroll bg-[#000]">
                <div class="bg-[#1a1a1a] p-3 rounded-r-xl rounded-bl-xl text-xs text-gray-300 border border-[#222] w-fit max-w-[85%]">
                    我是阿之。我已经接管了腾讯的数据流。<br>
                    1. 点击任意基金，我可以帮你穿透查看持仓股票。<br>
                    2. 在下方输入代码，我帮你预测走势。
                </div>
            </div>

            <div class="p-3 bg-[#111] border-t border-[#222]">
                <div class="flex gap-2 mb-2">
                    <button onclick="AI.analyze('holding')" class="flex-1 bg-blue-900/10 text-blue-400 py-2 rounded text-xs border border-blue-900/30">诊断持仓</button>
                    <button onclick="AI.analyze('watching')" class="flex-1 bg-green-900/10 text-green-400 py-2 rounded text-xs border border-green-900/30">机会挖掘</button>
                </div>
                <div class="relative">
                    <input id="aiInput" class="w-full bg-[#000] border border-[#333] rounded-lg p-3 pr-10 text-xs text-white focus:border-blue-500 outline-none" placeholder="输入代码或问题...">
                    <button onclick="AI.send()" class="absolute right-2 top-2.5 text-blue-500 p-1"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden p-4 space-y-4 fade-in">
            <div class="bg-[#141414] rounded-xl border border-[#222] p-4 space-y-4">
                <h3 class="font-bold text-gray-200 border-b border-[#222] pb-2">AI 引擎配置</h3>
                
                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">AI 提供商 (强烈推荐 DeepSeek)</label>
                    <select id="aiProvider" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white" onchange="Settings.toggleAiUI()">
                        <option value="deepseek">DeepSeek (国内直连/稳定)</option>
                        <option value="gemini">Google Gemini (需魔法)</option>
                        <option value="custom">Custom / Ollama</option>
                    </select>
                </div>

                <div id="endpointGroup" class="hidden">
                    <label class="text-[10px] text-gray-500 block mb-1">API Endpoint</label>
                    <input id="aiEndpoint" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-gray-400 font-mono" value="https://api.deepseek.com/chat/completions">
                </div>

                <div>
                    <label class="text-[10px] text-gray-500 block mb-1">API Key</label>
                    <input id="aiKey" type="password" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white font-mono" placeholder="sk-...">
                </div>

                <button onclick="Settings.save()" class="w-full bg-blue-600 py-2.5 rounded text-xs font-bold text-white">保存并连接</button>
            </div>

            <div class="bg-[#141414] rounded-xl border border-[#222] p-4">
                <h3 class="font-bold text-gray-200 border-b border-[#222] pb-2">数据维护</h3>
                <button onclick="App.resetAll()" class="w-full bg-red-900/20 text-red-500 border border-red-900/30 py-2 rounded text-xs mt-3">
                    <i class="fas fa-trash"></i> 清空所有数据
                </button>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full h-16 glass z-50 flex justify-around items-center pb-safe">
        <button onclick="App.nav('home')" class="nav-btn active w-1/4 flex flex-col items-center text-blue-500 transition-all" id="nav-home">
            <i class="fas fa-tachometer-alt text-lg mb-1"></i><span class="text-[10px]">驾驶舱</span>
        </button>
        <button onclick="App.nav('report')" class="nav-btn w-1/4 flex flex-col items-center text-gray-600 transition-all" id="nav-report">
            <i class="fas fa-file-alt text-lg mb-1"></i><span class="text-[10px]">早报</span>
        </button>
        <button onclick="App.nav('ai')" class="nav-btn w-1/4 flex flex-col items-center text-gray-600 transition-all" id="nav-ai">
            <i class="fas fa-brain text-lg mb-1"></i><span class="text-[10px]">智脑</span>
        </button>
        <button onclick="App.nav('settings')" class="nav-btn w-1/4 flex flex-col items-center text-gray-600 transition-all" id="nav-settings">
            <i class="fas fa-cog text-lg mb-1"></i><span class="text-[10px]">设置</span>
        </button>
    </nav>

    <div id="fundModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex flex-col p-4 animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-white font-bold text-lg" id="modalTitle">基金持仓穿透</h3>
            <button onclick="document.getElementById('fundModal').classList.add('hidden')" class="text-gray-400 p-2"><i class="fas fa-times"></i></button>
        </div>
        <div class="bg-[#1a1a1a] rounded-xl p-4 mb-4 border border-[#333]">
            <div class="text-xs text-gray-500 mb-2">AI 智能反查前十大重仓股 (实时行情)</div>
            <div id="modalStocks" class="space-y-2">
                <div class="text-center py-10"><div class="loader mx-auto mb-2"></div>正在连接交易所...</div>
            </div>
        </div>
    </div>

    <script>
        // === 1. 核心数据引擎 (Engine) ===
        const Engine = {
            cache: {},
            
            // 腾讯股票接口 (极速/无CORS)
            fetchStocks(codes, cb) {
                if(codes.length === 0) return cb();
                const s = document.createElement('script');
                s.src = `https://qt.gtimg.cn/q=${codes.join(',')}`;
                s.charset = 'gbk';
                s.onload = () => { this.parseTencent(codes); cb(); s.remove(); };
                s.onerror = () => { s.remove(); cb(); }; // Fail silently
                document.head.appendChild(s);
            },

            // 基金估值接口
            fetchFund(code, cb) {
                const s = document.createElement('script');
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                const old = window.jsonpgz;
                window.jsonpgz = (data) => {
                    this.cache['f_'+code] = { 
                        name: data.name, 
                        price: parseFloat(data.gsz), 
                        rate: parseFloat(data.gszzl),
                        time: data.gztime 
                    };
                    if(old) window.jsonpgz = old;
                    s.remove();
                    cb();
                };
                s.onerror = () => { s.remove(); cb(); };
                document.head.appendChild(s);
            },

            // 解析腾讯数据
            parseTencent(codes) {
                codes.forEach(c => {
                    const val = window['v_' + c];
                    if(!val) return;
                    const d = val.split('~');
                    // d[1]:名称, d[3]:现价, d[32]:涨跌幅, d[4]:昨收
                    this.cache[c] = {
                        name: d[1],
                        price: parseFloat(d[3]),
                        rate: parseFloat(d[32]),
                        close: parseFloat(d[4])
                    };
                });
            },

            // 资金流向 (东财接口 - 需要代理，这里用指数涨跌幅模拟趋势，为了稳定性)
            // 真实环境需要后端代理。V10版本我们用一种巧妙的方法：根据几大指数的加权平均涨跌来模拟“市场热度”
            getMarketFlow() {
                const sh = this.cache['sh000001']?.rate || 0;
                const sz = this.cache['sz399001']?.rate || 0;
                // 简单的算法：(上证 + 深证) * 100 亿 (模拟量级)
                return ((sh + sz) * 150).toFixed(1); 
            }
        };

        // === 2. AI 智脑 (DeepSeek/Gemini Adapter) ===
        const AI = {
            config: JSON.parse(localStorage.getItem('azhi_ai_conf') || '{"provider":"deepseek","key":"","endpoint":"","model":""}'),
            
            async chat(messages, onChunk) {
                if(!this.config.key) throw new Error("请先配置 API Key");
                
                let url = this.config.endpoint;
                let model = this.config.model;

                // 预设配置
                if(this.config.provider === 'deepseek') {
                    url = 'https://api.deepseek.com/chat/completions';
                    model = 'deepseek-chat';
                } else if(this.config.provider === 'gemini') {
                    // Gemini 特殊处理
                    return this.chatGemini(messages, onChunk);
                }

                // OpenAI 兼容格式 (DeepSeek/Ollama)
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.config.key}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: messages,
                            stream: false // 简化处理，不用流式
                        })
                    });
                    
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    return json.choices[0].message.content;
                } catch(e) {
                    throw e;
                }
            },

            async chatGemini(messages, onChunk) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.config.key}`;
                const prompt = messages[messages.length-1].content; // 简化：只发最后一句
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if(!res.ok) throw new Error(`Gemini Error ${res.status}`);
                const json = await res.json();
                return json.candidates[0].content.parts[0].text;
            },

            // 核心功能：AI 反查基金持仓
            async getFundStocks(fundName) {
                // 利用 LLM 的知识库来查询持仓 (比爬虫更稳定，虽然可能有滞后，但足够参考)
                const prompt = `请列出基金“${fundName}”的前5大重仓股票。
                只返回 JSON 格式，不要废话。格式：
                [{"code":"sh600519","name":"贵州茅台"}, {"code":"sz300750","name":"宁德时代"}]
                注意：代码必须带 sh/sz/hk/us 前缀。`;
                
                const jsonStr = await this.chat([{role:'user', content:prompt}]);
                // 提取 JSON
                const match = jsonStr.match(/\[.*\]/s);
                return match ? JSON.parse(match[0]) : [];
            },

            // 核心功能：分析持仓
            async analyze(type) {
                const assets = App.assets.filter(a => a.list === type);
                if(assets.length === 0) return alert("列表为空");
                
                // 构建上下文
                const context = assets.map(a => {
                    const k = a.type==='fund' ? 'f_'+a.code : App.fmtCode(a.code);
                    const d = Engine.cache[k];
                    return d ? `${d.name}:现价${d.price},涨幅${d.rate}%` : a.code;
                }).join('\n');

                const sysPrompt = "你是一个拥有20年经验的华尔街交易员，性格毒舌，说话刻薄但一针见血。";
                const userPrompt = `点评我的${type==='holding'?'持仓':'观察列表'}：\n${context}\n请指出最大的风险点。`;
                
                App.nav('ai');
                this.appendMsg('user', "帮我诊断一下账户。");
                this.appendMsg('system', "正在连接大脑...");
                
                try {
                    const reply = await this.chat([
                        {role: "system", content: sysPrompt},
                        {role: "user", content: userPrompt}
                    ]);
                    this.removeSystem();
                    this.appendMsg('ai', reply);
                } catch(e) {
                    this.removeSystem();
                    this.appendMsg('error', `AI 连接失败: ${e.message}`);
                }
            },

            // UI 辅助
            appendMsg(role, text) {
                const box = document.getElementById('chatBox');
                const colors = {
                    user: "bg-blue-900/30 text-blue-300 border-blue-800",
                    ai: "bg-[#222] text-gray-300 border-[#333]",
                    system: "bg-transparent text-gray-500 text-center text-[10px] animate-pulse border-none",
                    error: "bg-red-900/30 text-red-400 border-red-800"
                };
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl mb-3 text-xs border ${colors[role]} w-fit max-w-[90%] ${role==='user'?'ml-auto':''}`;
                div.innerHTML = role === 'system' ? text : `<b>${role.toUpperCase()}:</b> ${marked.parse(text)}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            },
            removeSystem() {
                const sys = document.querySelectorAll("#chatBox div");
                sys.forEach(d => { if(d.innerText.includes('正在连接')) d.remove(); });
            },
            clear() { document.getElementById('chatBox').innerHTML = ''; },
            send() {
                const v = document.getElementById('aiInput').value;
                if(!v) return;
                this.appendMsg('user', v);
                document.getElementById('aiInput').value = '';
                this.appendMsg('system', "思考中...");
                this.chat([{role:'user', content:v}]).then(r => {
                    this.removeSystem();
                    this.appendMsg('ai', r);
                }).catch(e => {
                    this.removeSystem();
                    this.appendMsg('error', e.message);
                });
            }
        };

        // === 3. App 控制器 ===
        const App = {
            assets: JSON.parse(localStorage.getItem('azhi_assets_v10') || '[]'),
            currentList: 'holding',
            
            init() {
                this.updateLoop();
                setInterval(() => this.updateLoop(), 2000); // 2秒刷新
                this.renderSettings();
                this.checkMarketStatus();
            },

            // --- 核心循环 ---
            async updateLoop() {
                document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                
                // 1. 收集代码
                const indices = ['sh000001', 'sz399001', 'usNDAQ', 'hkHSI', 'sc0']; // 上证, 深证, 纳指, 恒生, 原油连续
                const stocks = [];
                const funds = [];
                
                this.assets.forEach(a => {
                    if(a.type === 'fund') funds.push(a.code);
                    else stocks.push(this.fmtCode(a.code));
                });

                // 2. 并行请求
                const q = [...indices, ...stocks];
                if(q.length > 0) Engine.fetchStocks(q, () => this.render());
                funds.forEach(c => Engine.fetchFund(c, () => this.render()));

                document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#0f0]";
            },

            // --- 渲染逻辑 ---
            render() {
                this.renderIndices();
                this.renderAssets();
                this.renderTotal();
            },

            renderIndices() {
                const map = {'sh000001':'上证','sz399001':'深证','usNDAQ':'纳指','hkHSI':'恒生'};
                const grid = document.getElementById('indexGrid');
                grid.innerHTML = '';
                
                Object.keys(map).forEach(k => {
                    const d = Engine.cache[k];
                    if(d) {
                        const color = d.rate >= 0 ? 'text-red-500' : 'text-green-500';
                        grid.innerHTML += `
                            <div class="bg-[#141414] p-2 rounded-lg border border-[#222] text-center">
                                <div class="text-[9px] text-gray-500">${map[k]}</div>
                                <div class="font-bold text-xs mt-1 text-gray-200">${d.price.toFixed(2)}</div>
                                <div class="text-[9px] ${color}">${d.rate}%</div>
                            </div>
                        `;
                    }
                });
            },

            renderAssets() {
                const list = document.getElementById('assetList');
                list.innerHTML = '';
                const items = this.assets.filter(a => a.list === this.currentList);

                if(items.length === 0) return list.innerHTML = `<div class="p-8 text-center text-xs text-gray-600">暂无资产</div>`;

                items.forEach((a, i) => {
                    const realIdx = this.assets.indexOf(a);
                    const k = a.type === 'fund' ? 'f_'+a.code : this.fmtCode(a.code);
                    const d = Engine.cache[k];
                    
                    if(d) {
                        const color = d.rate >= 0 ? 'text-red-500' : 'text-green-500';
                        const pnlVal = a.cost > 0 ? (d.price - a.cost) * a.vol : 0;
                        const pnlRate = a.cost > 0 ? ((d.price - a.cost)/a.cost*100).toFixed(2) : 0;
                        
                        // 闪烁特效
                        const flashClass = (a.lastP && a.lastP !== d.price) ? (d.price > a.lastP ? 'tick-up' : 'tick-down') : '';
                        a.lastP = d.price;

                        // 基金点击事件
                        const onClick = a.type === 'fund' ? `onclick="App.showFundDetails('${a.code}', '${d.name}')"` : '';

                        list.innerHTML += `
                            <div class="p-3 flex justify-between items-center group relative overflow-hidden" ${onClick}>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] px-1.5 rounded ${a.type==='fund'?'bg-orange-900/40 text-orange-400':'bg-blue-900/40 text-blue-400'} font-bold">${a.type==='fund'?'基':'股'}</span>
                                        <span class="font-bold text-sm text-gray-200">${d.name}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-500 font-mono">
                                        ${this.currentList==='holding' ? `持 ${a.vol} | 盈 ${pnlVal.toFixed(0)}` : `现价 ${d.price}`}
                                    </div>
                                </div>
                                <div class="text-right px-2 rounded ${flashClass}">
                                    <div class="font-bold font-mono text-sm text-white">${d.price}</div>
                                    <div class="text-[10px] ${color} font-bold">${d.rate>0?'+':''}${d.rate}%</div>
                                </div>
                                <button onclick="event.stopPropagation(); App.delAsset(${realIdx})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-900 text-white translate-x-full group-hover:translate-x-0 transition-transform flex items-center justify-center">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                });
            },

            renderTotal() {
                let total = 0, dayPnl = 0;
                this.assets.forEach(a => {
                    if(a.list !== 'holding') return;
                    const k = a.type==='fund' ? 'f_'+a.code : this.fmtCode(a.code);
                    const d = Engine.cache[k];
                    if(d) {
                        const val = d.price * a.vol;
                        total += val;
                        dayPnl += val * (d.rate / 100) / (1 + d.rate / 100);
                    }
                });

                document.getElementById('totalAsset').innerText = Math.round(total).toLocaleString();
                const pEl = document.getElementById('dayPnL');
                pEl.innerText = (dayPnl>0?'+':'') + dayPnl.toFixed(2);
                pEl.className = `text-4xl font-bold font-mono tracking-tighter ${dayPnl>=0?'text-red-500':'text-green-500'}`;
                
                // 模拟资金流
                const flow = Engine.getMarketFlow();
                const fEl = document.getElementById('mainFlow');
                fEl.innerText = (flow>0?'+':'') + flow + '亿';
                fEl.className = `font-mono ${flow>0?'text-red-500':'text-green-500'}`;
                
                // 进度条动画
                const bar = document.getElementById('flowBar');
                const pct = 50 + (parseFloat(flow) / 200 * 50); // 简单的视觉映射
                bar.style.width = Math.min(Math.max(pct, 0), 100) + '%';
                bar.className = `h-full transition-all duration-1000 ${flow>0?'bg-red-600':'bg-green-600'}`;
            },

            // --- 基金穿透 (Showpiece Feature) ---
            async showFundDetails(code, name) {
                document.getElementById('fundModal').classList.remove('hidden');
                document.getElementById('modalTitle').innerText = name;
                const container = document.getElementById('modalStocks');
                container.innerHTML = `<div class="text-center py-10"><div class="loader mx-auto mb-2"></div>AI 正在穿透持仓数据...</div>`;

                try {
                    // 1. 问 AI 要持仓代码
                    const stocks = await AI.getFundStocks(name);
                    
                    if(stocks.length === 0) throw new Error("无法获取持仓");

                    // 2. 拿代码去问腾讯实时行情
                    const codes = stocks.map(s => s.code); // AI 返回的必须带前缀
                    Engine.fetchStocks(codes, () => {
                        let html = '';
                        codes.forEach(c => {
                            const d = Engine.cache[c];
                            if(d) {
                                const color = d.rate >= 0 ? 'text-red-500' : 'text-green-500';
                                html += `
                                    <div class="flex justify-between items-center p-2 bg-[#222] rounded border border-[#333]">
                                        <div>
                                            <div class="text-xs text-gray-300">${d.name}</div>
                                            <div class="text-[9px] text-gray-600 font-mono">${c}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-mono text-white">${d.price}</div>
                                            <div class="text-[10px] ${color}">${d.rate}%</div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        container.innerHTML = html || "暂无数据";
                    });

                } catch(e) {
                    container.innerHTML = `<div class="text-center text-red-500 text-xs">穿透失败: ${e.message}</div>`;
                }
            },

            // --- 晨间财报 (Report) ---
            generateReport: null, // Linked in Report object

            // --- 辅助工具 ---
            fmtCode(c) {
                if(/^[a-z]{2}/.test(c)) return c;
                if(/^\d{6}$/.test(c)) return (c.startsWith('6')?'sh':'sz') + c;
                if(/^\d{5}$/.test(c)) return 'hk' + c;
                if(/^[A-Z]+$/.test(c)) return 'us' + c;
                return c;
            },
            
            nav(page) {
                document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
                document.getElementById('view-'+page).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('span').classList.remove('text-blue-500');
                });
                document.getElementById('nav-'+page).classList.add('active');
            },

            switchList(type) {
                this.currentList = type;
                document.getElementById('tab-holding').className = type==='holding' ? 'flex-1 py-3 text-xs font-bold text-center border-b-2 border-blue-500 text-white' : 'flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-500';
                document.getElementById('tab-watching').className = type==='watching' ? 'flex-1 py-3 text-xs font-bold text-center border-b-2 border-blue-500 text-white' : 'flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-500';
                this.renderAssets();
            },

            openAdd() {
                const code = prompt("请输入代码 (例如: 600519, 00700, AAPL, 001840)");
                if(!code) return;
                
                let type = 'stock';
                if(/^\d{6}$/.test(code) && (code.startsWith('00')||code.startsWith('01'))) type='fund';
                if(confirm(`代码 ${code} 是基金吗？\n[确定] 是基金\n[取消] 是股票`)) type='fund';
                
                let vol=0, cost=0;
                if(this.currentList === 'holding') {
                    vol = prompt(type==='fund'?"持有份额":"持股数量", "100");
                    cost = prompt("持仓成本", "0");
                }
                
                this.assets.push({ 
                    code: code.toUpperCase(), 
                    type, 
                    list: this.currentList,
                    vol: parseFloat(vol)||0, 
                    cost: parseFloat(cost)||0 
                });
                localStorage.setItem('azhi_assets_v10', JSON.stringify(this.assets));
                this.updateLoop();
            },

            delAsset(i) {
                if(confirm("确定删除？")) {
                    this.assets.splice(i, 1);
                    localStorage.setItem('azhi_assets_v10', JSON.stringify(this.assets));
                    this.renderAssets();
                }
            },

            checkMarketStatus() {
                const h = new Date().getHours();
                const isOpen = (h >= 9 && h < 15) || (h >= 21 || h < 4); // A股+美股大致时间
                document.getElementById('marketStatus').innerText = isOpen ? "交易中" : "已闭市";
                document.getElementById('marketStatus').className = `text-[10px] px-2 py-0.5 rounded border border-[#333] ${isOpen?'text-green-500':'text-gray-500'}`;
            },

            resetAll() {
                if(confirm("高危操作：清空所有设置和资产？")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // === 4. 财报模块 ===
        const Report = {
            async generate() {
                const card = document.getElementById('reportCard');
                card.innerHTML = `<div class="text-center py-20"><div class="loader mx-auto mb-4"></div>阿之正在阅读全网新闻...</div>`;
                
                // 1. 获取指数数据
                const idx = {
                    sh: Engine.cache['sh000001']?.rate || 0,
                    nq: Engine.cache['usNDAQ']?.rate || 0,
                    hk: Engine.cache['hkHSI']?.rate || 0
                };
                
                // 2. 生成 Prompt
                const prompt = `现在时间是 ${new Date().toLocaleString()}。
                主要指数表现：上证 ${idx.sh}%, 纳指 ${idx.nq}%, 恒生 ${idx.hk}%。
                请以此为基础，结合你的知识库中最新的宏观经济信息（原油、黄金、美联储政策、中国政策），
                撰写一份《阿之晨间毒舌简报》。包含：
                1. 市场情绪打分 (0-100)
                2. 今日主要风险点
                3. 机会板块预测
                风格要犀利，像华尔街大佬写给内部的备忘录。`;

                try {
                    const text = await AI.chat([{role:'user', content:prompt}]);
                    card.innerHTML = `<div class="prose prose-invert prose-sm max-w-none text-gray-300">${marked.parse(text)}</div>`;
                } catch(e) {
                    card.innerHTML = `<div class="text-red-500 text-center">生成失败: ${e.message}</div>`;
                }
            }
        };

        // === 5. 设置模块 ===
        const Settings = {
            toggleAiUI() {
                const p = document.getElementById('aiProvider').value;
                const grp = document.getElementById('endpointGroup');
                grp.classList.toggle('hidden', p !== 'custom');
                
                // 自动填充推荐值
                if(p === 'deepseek') {
                    document.getElementById('aiEndpoint').value = 'https://api.deepseek.com/chat/completions';
                }
            },
            save() {
                const conf = {
                    provider: document.getElementById('aiProvider').value,
                    key: document.getElementById('aiKey').value.trim(),
                    endpoint: document.getElementById('aiEndpoint').value.trim() || 'https://api.deepseek.com/chat/completions',
                    model: 'deepseek-chat' // 默认模型
                };
                localStorage.setItem('azhi_ai_conf', JSON.stringify(conf));
                AI.config = conf;
                
                document.getElementById('aiModelBadge').innerText = conf.provider.toUpperCase();
                document.getElementById('aiModelBadge').className = "bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded text-[9px]";
                
                alert("AI 引擎已重置并激活！");
                App.nav('ai');
                AI.appendMsg('system', "AI 引擎已就绪。");
            }
        };

        // 启动
        window.onload = () => App.init();
    </script>
</body>
</html>
