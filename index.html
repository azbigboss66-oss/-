<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>åŸºç‹é˜¿ä¹‹Â·è…¾è®¯æ ¸åŠ¨åŠ›</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>

    <style>
        :root { --bg: #000; --card: #121212; --border: #333; --red: #ff453a; --green: #30d158; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        .no-scroll::-webkit-scrollbar { display: none; }
        
        /* ä»·æ ¼é—ªçƒ */
        .flash-red { animation: flashR 0.8s; }
        .flash-green { animation: flashG 0.8s; }
        @keyframes flashR { 0% { background: rgba(255, 69, 58, 0.4); } 100% { background: transparent; } }
        @keyframes flashG { 0% { background: rgba(48, 209, 88, 0.4); } 100% { background: transparent; } }

        /* è°ƒè¯•æ§åˆ¶å° - å¦‚æœå‡ºé”™ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ */
        #console-log { 
            display: none;
            position: fixed; bottom: 70px; left: 10px; right: 10px; 
            height: 100px; background: rgba(0,0,0,0.9); border: 1px solid #f00; 
            color: #f00; font-size: 10px; overflow-y: auto; z-index: 9999; padding: 5px;
        }
    </style>
</head>
<body class="flex flex-col h-screen w-full">

    <header class="h-12 flex items-center justify-between px-4 border-b border-[#222] bg-[#111] z-50">
        <div class="flex items-center gap-2">
            <div id="status" class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
            <h1 class="font-bold text-base">åŸºç‹é˜¿ä¹‹ <span class="text-[9px] bg-blue-900 text-blue-300 px-1 rounded font-mono">TENCENT</span></h1>
        </div>
        <button onclick="window.location.reload()" class="text-[10px] text-gray-500 border border-[#333] px-2 py-1 rounded">å¼ºåˆ¶åˆ·æ–°</button>
    </header>

    <main class="flex-1 overflow-y-auto no-scroll pb-32 bg-black relative" id="main">
        
        <div id="view-market" class="p-3 space-y-3">
            <div class="bg-[#121212] p-4 rounded-xl border border-[#222]">
                <div class="flex justify-between items-baseline">
                    <span class="text-[10px] text-gray-500">ä»Šæ—¥é¢„ä¼°ç›ˆäº</span>
                    <span id="updateTime" class="text-[10px] text-gray-600">--:--:--</span>
                </div>
                <div class="flex items-baseline gap-2 mt-1">
                    <span id="dayPnL" class="text-3xl font-bold font-mono tracking-tight text-white">0.00</span>
                    <span id="totalAsset" class="text-xs font-mono text-gray-400">æ€»èµ„: 0</span>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="indices">
                <div class="text-center text-[10px] text-gray-600 col-span-4 py-2">è…¾è®¯æ¥å£è¿æ¥ä¸­...</div>
            </div>

            <div class="bg-[#121212] rounded-xl border border-[#222] min-h-[300px]">
                <div class="flex justify-between items-center p-3 border-b border-[#222]">
                    <span class="text-sm font-bold">æˆ‘çš„æŒä»“</span>
                    <button onclick="App.addDialog()" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold shadow-lg shadow-blue-900/50">æ·»åŠ èµ„äº§</button>
                </div>
                <div id="list" class="divide-y divide-[#222]">
                    <div class="p-10 text-center text-gray-600 text-xs">
                        æš‚æ— æ•°æ®ã€‚è¯·ç‚¹å‡»å³ä¸Šæ–¹â€œæ·»åŠ èµ„äº§â€ã€‚<br>
                        (å¦‚æœå·²æ·»åŠ ä½†çœ‹ä¸åˆ°ï¼Œè¯·ç‚¹å‡»é¡¶éƒ¨çš„å¼ºåˆ¶åˆ·æ–°)
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ai" class="hidden flex flex-col h-full p-3 pb-0">
            <div class="flex-1 bg-[#121212] rounded-xl border border-[#222] flex flex-col overflow-hidden">
                <div class="h-8 bg-[#1a1a1a] flex items-center px-3 justify-between">
                    <span class="text-[10px] text-gray-500">æ¨¡å‹: Gemini Pro (Stable)</span>
                    <span class="text-[10px] text-green-500" id="aiStatus">å°±ç»ª</span>
                </div>
                <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-3 no-scroll">
                    <div class="bg-[#222] p-2 rounded text-xs text-gray-300 w-fit">
                        å·²åˆ‡æ¢è‡³ Gemini Pro ç¨³å®šç‰ˆæ¨¡å‹ã€‚404 é—®é¢˜å·²ä¿®å¤ã€‚<br>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•ã€‚
                    </div>
                </div>
                <div class="p-3 border-t border-[#222] bg-[#111]">
                    <div class="flex gap-2 mb-2">
                        <button onclick="AI.ask('holdings')" class="flex-1 bg-blue-900/30 text-blue-400 py-2 rounded text-xs">è¯Šæ–­æŒä»“</button>
                        <button onclick="AI.ask('market')" class="flex-1 bg-purple-900/30 text-purple-400 py-2 rounded text-xs">é¢„æµ‹å¤§ç›˜</button>
                    </div>
                    <div class="flex gap-2">
                        <input id="aiInput" class="flex-1 bg-black border border-[#333] rounded p-2 text-xs text-white" placeholder="è¾“å…¥ Key æˆ– æé—®...">
                        <button onclick="AI.send()" class="text-blue-500 px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <div id="view-settings" class="hidden p-4 space-y-4">
            <div class="bg-[#121212] rounded-xl p-4 border border-[#222]">
                <h3 class="font-bold text-gray-300 mb-4">ç³»ç»Ÿè®¾ç½®</h3>
                <label class="text-[10px] text-gray-500 block mb-1">Gemini API Key</label>
                <input id="apiKey" type="password" class="w-full bg-black border border-[#333] rounded p-2 text-xs text-white font-mono mb-4">
                
                <button onclick="App.saveSettings()" class="w-full bg-green-600 py-2 rounded text-xs font-bold mb-4">ä¿å­˜é…ç½®</button>
                
                <div class="border-t border-[#333] pt-4">
                    <button onclick="App.hardReset()" class="w-full bg-red-900/30 text-red-500 py-2 rounded text-xs font-bold border border-red-900/50">
                        âš ï¸ é‡ç½®æ‰€æœ‰æ•°æ® (ä¿®å¤å¡æ­»)
                    </button>
                </div>
                
                <div class="mt-4 text-[10px] text-gray-600 font-mono">
                    Build: V7.0-TENCENT<br>
                    Engine: qt.gtimg.cn
                </div>
            </div>
        </div>

    </main>

    <div id="console-log"></div>

    <nav class="fixed bottom-0 w-full h-16 bg-[#111] border-t border-[#222] flex justify-around items-center z-50 pb-safe">
        <button onclick="App.switch('market')" class="w-1/3 flex flex-col items-center text-blue-500" id="nav-market">
            <i class="fas fa-chart-bar text-lg"></i><span class="text-[10px]">è¡Œæƒ…</span>
        </button>
        <button onclick="App.switch('ai')" class="w-1/3 flex flex-col items-center text-gray-600" id="nav-ai">
            <i class="fas fa-robot text-lg"></i><span class="text-[10px]">é˜¿ä¹‹</span>
        </button>
        <button onclick="App.switch('settings')" class="w-1/3 flex flex-col items-center text-gray-600" id="nav-settings">
            <i class="fas fa-cog text-lg"></i><span class="text-[10px]">è®¾ç½®</span>
        </button>
    </nav>

    <script>
        // === ğŸš€ è…¾è®¯æ ¸åŠ¨åŠ›å¼•æ“ (Gtimg) ===
        const Engine = {
            cache: {},
            
            // è…¾è®¯æ¥å£ï¼šæé€Ÿã€æ— é˜²ç›—é“¾
            fetch(codes, cb) {
                const s = document.createElement('script');
                s.src = `https://qt.gtimg.cn/q=${codes}`;
                s.charset = 'gbk'; 
                s.id = 'tencent_script';
                
                s.onload = () => {
                    this.parse(codes.split(','));
                    cb(true);
                    s.remove();
                };
                s.onerror = (e) => {
                    // å¦‚æœè…¾è®¯ä¹ŸæŒ‚äº†ï¼Œé‚£å°±çœŸæ²¡ç½‘äº†
                    App.log("è…¾è®¯æ¥å£æ— æ³•è¿æ¥");
                    cb(false);
                    s.remove();
                };
                document.head.appendChild(s);
            },

            // åŸºé‡‘ä¼°å€¼
            fetchFund(code, cb) {
                const s = document.createElement('script');
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
                const old = window.jsonpgz;
                
                // åŠ«æŒå›è°ƒ
                window.jsonpgz = (data) => {
                    this.cache['f_'+code] = { name: data.name, price: +data.gsz, rate: +data.gszzl };
                    if(old) window.jsonpgz = old;
                    s.remove();
                    cb();
                };
                
                s.onerror = () => {
                    App.log(`åŸºé‡‘ ${code} æ•°æ®è·å–å¤±è´¥`);
                    s.remove();
                };
                document.head.appendChild(s);
            },

            parse(codes) {
                codes.forEach(c => {
                    // è…¾è®¯å˜é‡å: v_sh600519
                    const val = window['v_' + c];
                    if(!val) return;
                    
                    const d = val.split('~');
                    // d[1]:åå­—, d[3]:ç°ä»·, d[32]:æ¶¨è·Œ%
                    this.cache[c] = {
                        name: d[1],
                        price: parseFloat(d[3]),
                        rate: parseFloat(d[32])
                    };
                });
            }
        };

        const App = {
            // æ³¨æ„ï¼šV7 ä½¿ç”¨å…¨æ–°çš„å­˜å‚¨ Keyï¼Œé˜²æ­¢æ—§æ•°æ®æ±¡æŸ“
            assets: JSON.parse(localStorage.getItem('azhi_v7_assets') || '[]'),
            key: localStorage.getItem('azhi_key') || '',
            timer: null,

            init() {
                if(this.key) document.getElementById('apiKey').value = this.key;
                
                // é»˜è®¤æ·»åŠ å‡ ä¸ªæŒ‡æ•°ï¼Œé˜²æ­¢é¦–é¡µç©ºç™½
                if(this.assets.length === 0) {
                    // ä¸è‡ªåŠ¨æ·»åŠ ï¼Œä¿æŒæ¸…çˆ½ï¼Œä½†ä¼šåœ¨UIæç¤º
                }

                this.loop();
                this.timer = setInterval(() => this.loop(), 2000);
            },

            async loop() {
                // 1. æ•´ç†ä»£ç 
                const stocks = ['sh000001', 'sz399006', 'usNDAQ', 'hkHSI']; // æŒ‡æ•°
                const myStocks = [];
                const myFunds = [];

                this.assets.forEach(a => {
                    if(a.type === 'fund') myFunds.push(a.code);
                    else myStocks.push(this.formatCode(a.code));
                });

                // 2. è…¾è®¯æ¥å£ (è‚¡ç¥¨+æŒ‡æ•°)
                const q = [...stocks, ...myStocks].join(',');
                if(q) {
                    Engine.fetch(q, (ok) => {
                        document.getElementById('status').className = ok ? "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#0f0]" : "w-2 h-2 rounded-full bg-red-500";
                        this.render();
                    });
                }

                // 3. åŸºé‡‘æ¥å£ (ç‹¬ç«‹)
                myFunds.forEach(c => Engine.fetchFund(c, () => this.render()));
                
                document.getElementById('updateTime').innerText = dayjs().format('HH:mm:ss') + " åŒæ­¥ä¸­";
            },

            formatCode(c) {
                // æ™ºèƒ½è¯†åˆ«å‰ç¼€
                if(/^[a-z]{2}/.test(c)) return c; // å·²æœ‰å‰ç¼€
                if(/^\d{6}$/.test(c)) return (c.startsWith('6')?'sh':'sz') + c;
                if(/^\d{5}$/.test(c)) return 'hk' + c; // æ¸¯è‚¡
                if(/^[A-Z]+$/.test(c)) return 'us' + c; // ç¾è‚¡
                return c;
            },

            render() {
                // æ¸²æŸ“æŒ‡æ•°
                const idxMap = { 'sh000001':'ä¸Šè¯', 'sz399006':'åˆ›ä¸š', 'usNDAQ':'çº³æŒ‡', 'hkHSI':'æ’ç”Ÿ' };
                const idxDiv = document.getElementById('indices');
                idxDiv.innerHTML = '';
                Object.keys(idxMap).forEach(k => {
                    const d = Engine.cache[k];
                    if(d) {
                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        idxDiv.innerHTML += `
                            <div class="bg-[#161616] p-2 rounded text-center border border-[#222]">
                                <div class="text-[9px] text-gray-500">${idxMap[k]}</div>
                                <div class="font-bold text-xs mt-1 text-white">${d.price}</div>
                                <div class="text-[9px] ${color}">${d.rate}%</div>
                            </div>`;
                    }
                });

                // æ¸²æŸ“åˆ—è¡¨ & è®¡ç®—
                const list = document.getElementById('list');
                list.innerHTML = '';
                let totalPnL = 0;
                let totalAsset = 0;

                if(this.assets.length === 0) list.innerHTML = `<div class="p-10 text-center text-gray-600 text-xs">æš‚æ— èµ„äº§ï¼Œè¯·ç‚¹å‡»æ·»åŠ </div>`;

                this.assets.forEach((a, i) => {
                    const key = a.type==='fund' ? 'f_'+a.code : this.formatCode(a.code);
                    const d = Engine.cache[key];
                    
                    if(d) {
                        const val = d.price * a.vol;
                        // ä¼°ç®—å½“æ—¥ç›ˆäº
                        const pnl = val * (d.rate/100) / (1 + d.rate/100);
                        totalPnL += pnl;
                        totalAsset += val;

                        const color = d.rate>=0 ? 'text-red-500' : 'text-green-500';
                        // é—ªçƒæ£€æµ‹
                        const flash = (a.lastP && a.lastP !== d.price) ? (d.price>a.lastP?'flash-red':'flash-green') : '';
                        a.lastP = d.price;

                        list.innerHTML += `
                            <div class="p-3 flex justify-between items-center group relative overflow-hidden">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] px-1 rounded ${a.type==='fund'?'bg-orange-900/50 text-orange-300':'bg-blue-900/50 text-blue-300'}">${a.type==='fund'?'åŸº':'è‚¡'}</span>
                                        <span class="font-bold text-sm text-gray-300">${d.name}</span>
                                    </div>
                                    <div class="text-[10px] text-gray-600 mt-1">${a.code} | æŒ ${a.vol}</div>
                                </div>
                                <div class="text-right px-2 rounded ${flash}">
                                    <div class="font-bold font-mono text-sm text-gray-200">${d.price}</div>
                                    <div class="text-[10px] ${color}">${d.rate>0?'+':''}${d.rate}%</div>
                                </div>
                                <button onclick="App.del(${i})" class="absolute right-0 top-0 bottom-0 w-12 bg-red-900 text-white translate-x-full group-hover:translate-x-0 transition-transform">åˆ </button>
                            </div>
                        `;
                    } else {
                        list.innerHTML += `<div class="p-3 text-xs text-gray-600">åŠ è½½ä¸­: ${a.code}</div>`;
                    }
                });

                document.getElementById('dayPnL').innerText = (totalPnL>0?'+':'') + totalPnL.toFixed(2);
                document.getElementById('dayPnL').className = `text-3xl font-bold font-mono tracking-tight ${totalPnL>=0?'text-red-500':'text-green-500'}`;
                document.getElementById('totalAsset').innerText = `æ€»èµ„: ${Math.round(totalAsset)}`;
            },

            addDialog() {
                const code = prompt("è¯·è¾“å…¥ä»£ç  (æ”¯æŒ: 600519, 00700, AAPL, 001840)");
                if(!code) return;
                
                let type = 'stock';
                if(/^\d{6}$/.test(code) && (code.startsWith('00')||code.startsWith('01'))) type='fund';
                if(confirm(`${code} æ˜¯åŸºé‡‘å—? \nç‚¹å‡» [ç¡®å®š] æ˜¯åŸºé‡‘\nç‚¹å‡» [å–æ¶ˆ] æ˜¯è‚¡ç¥¨`)) type='fund'; else type='stock';
                
                const vol = prompt("æŒæœ‰æ•°é‡", "100");
                
                this.assets.push({ code, type, vol: parseFloat(vol)||0, cost:0 });
                localStorage.setItem('azhi_v7_assets', JSON.stringify(this.assets));
                // ç«‹å³åˆ·æ–°
                this.loop();
            },

            del(i) {
                if(confirm("ç¡®å®šåˆ é™¤å—?")) {
                    this.assets.splice(i, 1);
                    localStorage.setItem('azhi_v7_assets', JSON.stringify(this.assets));
                    this.render();
                }
            },

            saveSettings() {
                const k = document.getElementById('apiKey').value.trim();
                // ç®€å•æ ¡éªŒ
                if(k && !k.startsWith('AIza')) {
                    alert("è­¦å‘Šï¼šAPI Key æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ (é€šå¸¸ä»¥ AIza å¼€å¤´)");
                }
                this.key = k;
                localStorage.setItem('azhi_key', this.key);
                alert("è®¾ç½®å·²ä¿å­˜");
                location.reload();
            },

            hardReset() {
                if(confirm("è¿™å°†æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Œç”¨äºä¿®å¤å¡æ­»é—®é¢˜ã€‚ç¡®å®šå—ï¼Ÿ")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            switch(page) {
                ['market','ai','settings'].forEach(p => {
                    document.getElementById('view-'+p).className = p===page?'block h-full':'hidden';
                    const btn = document.getElementById('nav-'+p);
                    if(p===page) {
                        btn.className = "w-1/3 flex flex-col items-center text-blue-500 transition-colors";
                    } else {
                        btn.className = "w-1/3 flex flex-col items-center text-gray-600 transition-colors";
                    }
                });
            },

            log(msg) {
                const c = document.getElementById('console-log');
                c.style.display = 'block';
                c.innerHTML += `<div>> ${msg}</div>`;
                c.scrollTop = c.scrollHeight;
            }
        };

        // === ğŸ§  AI ä¿®å¤ç‰ˆ (Gemini Pro) ===
        const AI = {
            async ask(type) {
                if(!App.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key");
                
                document.getElementById('aiStatus').innerText = "è¯·æ±‚ä¸­...";
                this.reply("User", type === 'holdings' ? "å¸®æˆ‘è¯Šæ–­æŒä»“" : "é¢„æµ‹å¤§ç›˜");
                this.reply("System", "æ­£åœ¨è¿æ¥å¤§è„‘...");
                
                // 1. æ•°æ®å‡†å¤‡
                const context = App.assets.map(a => {
                    const k = a.type==='fund' ? 'f_'+a.code : App.formatCode(a.code);
                    const d = Engine.cache[k];
                    return d ? `${d.name}:ç°ä»·${d.price},æ¶¨å¹…${d.rate}%` : a.code;
                }).join('; ');

                const prompt = `æˆ‘æ˜¯æ¿€è¿›æŠ•èµ„è€…ã€‚æŒä»“: [${context}]ã€‚è¯·æ¯’èˆŒç‚¹è¯„æˆ‘çš„ç›ˆäºã€‚`;
                
                // 2. å‘é€ (ä½¿ç”¨ gemini-pro æ¨¡å‹)
                try {
                    // å°è¯• Gemini Pro (v1beta)
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${App.key}`;
                    
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if(res.status === 404) throw new Error("404: æ¨¡å‹ä¸å¯ç”¨ã€‚å¯èƒ½æ˜¯ Key æƒé™é—®é¢˜ï¼Œæˆ– IP è¢« Google å°é”ã€‚");
                    if(res.status === 400) throw new Error("400: Key æ— æ•ˆã€‚");
                    if(!res.ok) throw new Error(`HTTP Error ${res.status}`);
                    
                    const json = await res.json();
                    if(json.error) throw new Error(json.error.message);
                    
                    const text = json.candidates[0].content.parts[0].text;
                    this.reply("é˜¿ä¹‹", text);
                    document.getElementById('aiStatus').innerText = "æ­£å¸¸";
                } catch(e) {
                    this.reply("Error", `è¿æ¥å¤±è´¥: ${e.message}`);
                    document.getElementById('aiStatus').innerText = "é”™è¯¯";
                    App.log(`AI Error: ${e.message}`);
                }
            },
            
            reply(role, text) {
                const box = document.getElementById('chatBox');
                // ç§»é™¤"æ­£åœ¨è¿æ¥..."æç¤º
                if(text === "æ­£åœ¨è¿æ¥å¤§è„‘...") return; 
                
                const color = role === 'User' ? 'text-blue-400' : (role === 'Error' ? 'text-red-500' : 'text-gray-300');
                box.innerHTML += `
                    <div class="bg-[#222] p-2 rounded mb-2 text-xs ${color} border border-[#333]">
                        <b class="opacity-50">${role}:</b> ${marked.parse(text)}
                    </div>`;
                box.scrollTop = box.scrollHeight;
            },

            send() {
                const v = document.getElementById('aiInput').value;
                if(v) {
                    // å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ Keyï¼Œè‡ªåŠ¨ä¿å­˜
                    if(v.startsWith('AIza')) {
                        document.getElementById('apiKey').value = v;
                        App.saveSettings();
                        return;
                    }
                    AI.reply("User", v);
                    // å¤ç”¨é€»è¾‘ï¼Œå¸¦ä¸ŠæŒä»“æ•°æ®ä¸€èµ·å‘
                    AI.ask('holdings'); 
                    document.getElementById('aiInput').value = '';
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
